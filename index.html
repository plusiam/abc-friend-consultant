<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABC 통합 컨설팅: 친구 돕기 역할극</title>
    <meta name="description" content="ABC 사고 모델과 4단계 컨설팅을 통합한 교육용 역할극 도구">
    
    <!-- Tailwind CSS CDN (GitHub Pages 안정적 버전) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas CDN (백업 포함) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" 
            onerror="this.onerror=null; this.src='https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js'"></script>
    
    <!-- 한글 폰트 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* 커스텀 애니메이션 */
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn-hover:hover { transform: translateY(-2px); transition: all 0.2s; }
        .mode-btn.active { background: linear-gradient(135deg, #10b981, #059669); }
        .abc-card { transition: all 0.2s; cursor: pointer; }
        .abc-card:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .abc-card.filled { background: linear-gradient(135deg, #dbeafe, #93c5fd); }
        
        /* 고민 카드 스타일 */
        .case-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #3b82f6;
        }
        .case-card.selected {
            border-color: #8b5cf6 !important;
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        .case-card.selected::before {
            content: '✅';
            position: absolute;
            top: 8px;
            right: 8px;
            background: #8b5cf6;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 10;
        }
        
        /* ABC 카드 스타일 개선 */
        .abc-card {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: visible;
        }
        .abc-card:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            z-index: 10;
        }
        .abc-card.filled {
            background: linear-gradient(135deg, #dbeafe, #93c5fd);
        }
        .abc-card.active {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
            border-width: 3px;
        }
        
        /* ABC 가이드 툴팁 */
        .abc-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid;
            border-radius: 12px;
            padding: 12px;
            min-width: 250px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 20;
            margin-bottom: 8px;
        }
        .abc-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: inherit;
        }
        .abc-card:hover .abc-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-8px);
        }
        
        /* 3단계 가이드 카드 스타일 */
        .reframe-card {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: visible;
            border: 2px solid transparent;
        }
        .reframe-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            z-index: 10;
            border-color: #8b5cf6;
        }
        .reframe-card.active {
            transform: scale(1.03);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
            border-width: 3px;
        }
        
        /* 3단계 툴팁 */
        .reframe-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid;
            border-radius: 12px;
            padding: 12px;
            min-width: 280px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 20;
            margin-bottom: 8px;
        }
        .reframe-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: inherit;
        }
        .reframe-card:hover .reframe-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-8px);
        }
        
        /* 3단계별 색상 */
        .reframe-old .reframe-tooltip { border-color: #64748b; }
        .reframe-old .reframe-tooltip::after { border-top-color: #64748b; }
        .reframe-new .reframe-tooltip { border-color: #8b5cf6; }
        .reframe-new .reframe-tooltip::after { border-top-color: #8b5cf6; }
        .reframe-action .reframe-tooltip { border-color: #06b6d4; }
        .reframe-action .reframe-tooltip::after { border-top-color: #06b6d4; }
        
        /* 단계 네비게이션 */
        .step-nav-btn { 
            transition: all 0.2s; 
            cursor: pointer; 
            border: 2px solid transparent;
        }
        .step-nav-btn:hover:not(.step-nav-active) { 
            background: #e5e7eb !important; 
            transform: translateY(-1px); 
        }
        .step-nav-btn.step-nav-active { 
            border-color: #059669;
            box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.2);
        }
        .step-nav-btn.step-nav-visited { 
            background: #d1fae5 !important; 
            color: #065f46 !important; 
        }
        .step-nav-btn.step-nav-completed {
            background: #10b981 !important;
            color: white !important;
        }
        
        /* 역할 구분 색상 */
        .role-consultant { border-left: 4px solid #10b981; background: #f0fdf4; }
        .role-client { border-left: 4px solid #3b82f6; background: #eff6ff; }
        
        /* 감정 버튼 스타일 */
        .emotion-btn.selected {
            border-color: #10b981;
            background-color: #d1fae5;
            color: #065f46;
            font-weight: 600;
        }
        
        /* 반응형 그리드 */
        @media (max-width: 768px) {
            .grid-responsive { grid-template-columns: 1fr; }
        }
        
        /* 텍스트 말줄임 */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* 애니메이션 */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        
        /* 인쇄 스타일 */
        @media print {
            body * { visibility: hidden; }
            #printable-consultation, #printable-consultation * { 
                visibility: visible; 
            }
            #printable-consultation {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white !important;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        
        <!-- 메인 헤더 -->
        <header class="text-center bg-white rounded-2xl shadow-lg p-6 mb-6 border-t-4 border-green-500">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">🎭 ABC 통합 컨설팅</h1>
            <p class="text-gray-600 mb-4">ABC 사고 분석과 4단계 컨설팅으로 친구를 도와주는 역할극 연습</p>
            <div class="flex justify-center items-center gap-4 text-sm mb-4">
                <div class="role-consultant px-3 py-1 rounded-full">👨‍🏫 컨설턴트</div>
                <div class="role-client px-3 py-1 rounded-full">🙋‍♀️ 내담자</div>
            </div>
            
            <!-- 자동 저장 상태 표시 -->
            <div class="flex justify-center items-center gap-4 text-xs text-gray-500">
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                    <span>자동 저장 중</span>
                </div>
                <button id="manual-save-btn" class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg transition-colors text-gray-600 hover:text-gray-800">
                    💾 수동 저장
                </button>
                <button id="clear-data-btn" class="bg-red-100 hover:bg-red-200 px-3 py-1 rounded-lg transition-colors text-red-600 hover:text-red-800">
                    🗑️ 데이터 초기화
                </button>
            </div>
        </header>

        <!-- 시작 화면 -->
        <div id="start-screen" class="slide-in">
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 역할극 준비하기</h2>
                    <p class="text-gray-600">두 명이 짝을 이뤄 컨설턴트와 내담자 역할을 번갈아 해보며 4단계 컨설팅을 연습해보세요.</p>
                </div>

                <!-- 참가자 정보 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="role-consultant p-4 rounded-lg">
                        <h3 class="font-bold text-green-700 mb-3">👨‍🏫 컨설턴트 (도움 주는 사람)</h3>
                        <div class="space-y-3">
                            <input type="text" id="consultant-name" placeholder="이름" class="w-full p-2 border rounded-lg">
                            <input type="text" id="consultant-class" placeholder="학년/반" class="w-full p-2 border rounded-lg">
                        </div>
                    </div>
                    <div class="role-client p-4 rounded-lg">
                        <h3 class="font-bold text-blue-700 mb-3">🙋‍♀️ 내담자 (도움 받는 사람)</h3>
                        <div class="space-y-3">
                            <input type="text" id="client-name" placeholder="이름" class="w-full p-2 border rounded-lg">
                            <input type="text" id="client-class" placeholder="학년/반" class="w-full p-2 border rounded-lg">
                        </div>
                    </div>
                </div>

                <!-- 사례 선택 -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">💭 어떤 고민을 다뤄볼까요?</h3>
                    
                    <!-- 모드 선택 -->
                    <div class="flex gap-4 mb-4">
                        <button id="random-mode" class="mode-btn active px-6 py-3 text-white rounded-lg flex-1 btn-hover">
                            🎲 준비된 사례 (50가지)
                        </button>
                        <button id="custom-mode" class="mode-btn px-6 py-3 bg-gray-300 text-gray-700 rounded-lg flex-1 btn-hover">
                            ✏️ 직접 입력하기
                        </button>
                    </div>

                    <!-- 랜덤 사례 영역 -->
                    <div id="random-case-area" class="case-mode-area">
                        <div class="text-center mb-4">
                            <p class="text-lg font-semibold text-gray-700 mb-2">🎯 상황을 선택해주세요</p>
                            <div class="flex justify-between items-center">
                                <p class="text-sm text-gray-500">총 <span id="total-cases-count">50</span>가지 상황이 준비되어 있어요!</p>
                                <button id="shuffle-cases-btn" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm btn-hover">
                                    🔄 다른 예시
                                </button>
                            </div>
                        </div>
                        
                        <!-- 고민 카드들 -->
                        <div id="case-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
                            <!-- 동적으로 생성될 카드들 -->
                        </div>
                        
                        <!-- 선택된 사례 표시 -->
                        <div id="selected-case-display" class="bg-blue-50 border-2 border-blue-300 p-4 rounded-lg hidden">
                            <h4 class="font-bold text-blue-800 mb-2">✅ 선택된 고민</h4>
                            <div id="selected-case-content" class="text-blue-700">
                                <!-- 선택된 사례 내용 -->
                            </div>
                        </div>
                    </div>

                    <!-- 직접 입력 영역 -->
                    <div id="custom-case-area" class="case-mode-area hidden">
                        <div class="bg-yellow-50 p-3 rounded-lg mb-4 text-sm">
                            <p class="font-bold text-yellow-800">📝 입력 가이드</p>
                            <ul class="text-yellow-700 ml-4 list-disc">
                                <li>실명 대신 "친구", "선생님" 등으로 표현해주세요</li>
                                <li>실제 경험이나 가상 상황 모두 괜찮아요</li>
                                <li>다른 친구들도 학습할 수 있는 사례면 더 좋아요</li>
                            </ul>
                        </div>
                        <div class="space-y-3">
                            <input id="custom-title" type="text" placeholder="고민 제목 (예: 친구와의 갈등)" class="w-full p-3 border rounded-lg">
                            <textarea id="custom-content" rows="4" placeholder="상황을 구체적으로 설명해주세요..." class="w-full p-3 border rounded-lg"></textarea>
                        </div>
                    </div>
                </div>

                <button id="start-roleplay-btn" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white font-bold py-4 text-lg rounded-lg btn-hover">
                    🎭 역할극 시작하기
                </button>
            </div>
        </div>

        <!-- 역할극 화면 -->
        <div id="roleplay-screen" class="hidden slide-in">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- 왼쪽: 현재 단계 & 안내 -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-4">
                        <!-- 단계 네비게이션 -->
                        <div class="text-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">컨설팅 단계</h3>
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <button id="step-nav-1" class="step-nav-btn step-nav-active px-3 py-2 text-sm rounded-lg bg-green-500 text-white font-medium" data-step="1">
                                    💚 1단계<br><span class="text-xs">공감하기</span>
                                </button>
                                <button id="step-nav-2" class="step-nav-btn px-3 py-2 text-sm rounded-lg bg-gray-300 text-gray-600 font-medium" data-step="2">
                                    🔍 2단계<br><span class="text-xs">ABC 분석</span>
                                </button>
                                <button id="step-nav-3" class="step-nav-btn px-3 py-2 text-sm rounded-lg bg-gray-300 text-gray-600 font-medium" data-step="3">
                                    ✨ 3단계<br><span class="text-xs">새로운 생각</span>
                                </button>
                                <button id="step-nav-4" class="step-nav-btn px-3 py-2 text-sm rounded-lg bg-gray-300 text-gray-600 font-medium" data-step="4">
                                    🎁 4단계<br><span class="text-xs">격려하기</span>
                                </button>
                            </div>
                            <p class="text-sm text-gray-600" id="step-desc">마음을 따뜻하게 공감해주세요</p>
                        </div>

                        <!-- 현재 역할 표시 -->
                        <div class="mb-6">
                            <div id="role-display" class="role-consultant p-3 rounded-lg text-center">
                                <div class="font-bold">👨‍🏫 현재 컨설턴트</div>
                                <div class="text-sm" id="current-consultant">김민수</div>
                            </div>
                        </div>

                        <!-- 단계별 가이드 -->
                        <div id="step-guide" class="space-y-3 text-sm">
                            <div class="bg-green-50 p-3 rounded-lg">
                                <div class="font-bold text-green-700">💚 공감 포인트</div>
                                <ul class="list-disc ml-4 text-green-600">
                                    <li>감정을 인정해주기</li>
                                    <li>"힘들었겠구나" 표현</li>
                                    <li>비슷한 경험 공유</li>
                                </ul>
                            </div>
                        </div>

                        <!-- 단계 이동 버튼들 -->
                        <div class="space-y-2 mt-4">
                            <button id="prev-step-btn" class="w-full bg-gray-400 text-white font-bold py-2 rounded-lg btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                ⬅️ 이전 단계로
                            </button>
                            <button id="next-step-btn" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg btn-hover">
                                ➡️ 다음 단계로
                            </button>
                        </div>
                        
                        <!-- 역할 교체 버튼 -->
                        <button id="switch-roles-btn" class="w-full bg-orange-500 text-white font-bold py-2 rounded-lg mt-4 btn-hover">
                            🔄 역할 바꾸기
                        </button>
                    </div>
                </div>

                <!-- 오른쪽: 컨설팅 작업 영역 -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        
                        <!-- 고민 사례 표시 -->
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <h4 class="font-bold text-gray-800 mb-2" id="displayed-title">현재 고민</h4>
                            <p class="text-gray-700" id="displayed-content">고민 내용이 여기에 표시됩니다.</p>
                        </div>

                        <!-- 1단계: 공감하기 -->
                        <div id="step1-empathy" class="step-content bg-green-50 p-4 rounded-lg mb-4">
                            <h4 class="text-lg font-bold text-green-700 mb-3">💚 1단계: 마음 공감하기</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">🎭 내담자의 감정 파악하기</label>
                                    <div id="recommended-emotions" class="grid grid-cols-3 gap-2 mb-3">
                                        <!-- 동적으로 생성될 감정 버튼들 -->
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="text" id="direct-emotion-input" placeholder="직접 감정 입력" class="flex-1 p-2 border rounded-lg text-sm">
                                        <button id="add-direct-emotion-btn" class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm btn-hover">추가</button>
                                    </div>
                                    <div class="mt-2">
                                        <div class="text-xs text-gray-600 mb-1">선택된 감정들:</div>
                                        <div id="selected-emotions-list" class="flex flex-wrap gap-1">
                                            <span class="text-xs text-gray-500">감정을 선택하거나 입력해주세요</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">💚 공감 표현하기</label>
                                    <textarea id="empathy-text" rows="3" class="w-full p-3 border rounded-lg" 
                                              placeholder="친구의 감정을 인정하고 공감하는 말을 해보세요..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- 2단계: ABC 함께 분석하기 -->
                        <div id="step2-abc" class="step-content hidden bg-blue-50 p-4 rounded-lg mb-4">
                            <h4 class="text-lg font-bold text-blue-700 mb-3">🔍 2단계: ABC 함께 분석하기</h4>
                            
                            <!-- ABC 설명 -->
                            <div class="bg-white p-4 rounded-lg mb-4 border-l-4 border-blue-500">
                                <p class="text-sm text-gray-700 mb-2">
                                    <strong>💡 ABC 분석 방법:</strong> 상황을 세 부분으로 나누어 차근차근 정리해보세요
                                </p>
                                <p class="text-xs text-gray-600">
                                    각 카드에 마우스를 올리면 상세 가이드가 나타나요. 클릭하면 해당 영역으로 이동합니다!
                                </p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="abc-card abc-a bg-white p-4 rounded-lg text-center border-2 border-red-300 relative" data-abc="A">
                                    <div class="font-bold text-red-600 text-2xl mb-1">A</div>
                                    <div class="text-sm text-red-600 font-medium">사실/사건</div>
                                    <div class="text-xs text-red-500 mt-1">Antecedent</div>
                                    
                                    <!-- 툴팁 -->
                                    <div class="abc-tooltip">
                                        <div class="font-bold text-red-700 mb-2">🔍 A: 사실과 사건</div>
                                        <div class="text-xs text-gray-700 space-y-1">
                                            <div><strong>✓ 포함할 것:</strong></div>
                                            <div>• 실제로 일어난 일</div>
                                            <div>• 관찰 가능한 사실</div>
                                            <div>• 언제, 어디서, 누가, 무엇을</div>
                                            <div class="mt-2"><strong>✗ 제외할 것:</strong></div>
                                            <div>• 내 생각이나 해석</div>
                                            <div>• 감정이나 기분</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="abc-card abc-b bg-white p-4 rounded-lg text-center border-2 border-orange-300 relative" data-abc="B">
                                    <div class="font-bold text-orange-600 text-2xl mb-1">B</div>
                                    <div class="text-sm text-orange-600 font-medium">생각/신념</div>
                                    <div class="text-xs text-orange-500 mt-1">Belief</div>
                                    
                                    <!-- 툴팁 -->
                                    <div class="abc-tooltip">
                                        <div class="font-bold text-orange-700 mb-2">🧠 B: 생각과 신념</div>
                                        <div class="text-xs text-gray-700 space-y-1">
                                            <div><strong>✓ 포함할 것:</strong></div>
                                            <div>• 그 상황에서 든 생각</div>
                                            <div>• 나의 해석과 판단</div>
                                            <div>• "~라고 생각했다"</div>
                                            <div class="mt-2"><strong>🔍 찾는 질문:</strong></div>
                                            <div>• 그때 머릿속에 뭐가 떠올랐지?</div>
                                            <div>• 어떻게 받아들였지?</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="abc-card abc-c bg-white p-4 rounded-lg text-center border-2 border-blue-300 relative" data-abc="C">
                                    <div class="font-bold text-blue-600 text-2xl mb-1">C</div>
                                    <div class="text-sm text-blue-600 font-medium">결과</div>
                                    <div class="text-xs text-blue-500 mt-1">Consequence</div>
                                    
                                    <!-- 툴팁 -->
                                    <div class="abc-tooltip">
                                        <div class="font-bold text-blue-700 mb-2">💫 C: 결과와 반응</div>
                                        <div class="text-xs text-gray-700 space-y-1">
                                            <div><strong>✓ 포함할 것:</strong></div>
                                            <div>• 그때 느낀 감정</div>
                                            <div>• 실제로 한 행동</div>
                                            <div>• 몸의 반응 (심장 빨라짐 등)</div>
                                            <div class="mt-2"><strong>🔍 찾는 질문:</strong></div>
                                            <div>• 기분이 어땠지?</div>
                                            <div>• 어떻게 행동했지?</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 동적 가이드 영역 -->
                            <div id="abc-guide-area" class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4 hidden">
                                <div id="abc-guide-content">
                                    <!-- 선택된 ABC에 따른 가이드가 여기에 표시 -->
                                </div>
                            </div>
                            
                            <!-- 입력 영역 -->
                            <div class="bg-white rounded-lg p-4 border-2 border-gray-200">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-sm font-semibold text-gray-700">📝 ABC 분석 작성하기</label>
                                    <button id="abc-example-btn" class="bg-purple-500 text-white px-3 py-1 rounded-lg text-xs btn-hover">
                                        💡 예시 보기
                                    </button>
                                </div>
                                <textarea id="abc-analysis" rows="4" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          placeholder="A: 정확히 무슨 일이 일어났는지 써보세요...&#10;B: 그때 어떤 생각이 들었는지 써보세요...&#10;C: 어떤 기분이었고 어떻게 행동했는지 써보세요..."></textarea>
                                
                                <!-- ABC 체크리스트 -->
                                <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div class="bg-red-50 p-2 rounded text-xs">
                                        <div class="font-semibold text-red-700 mb-1">A 체크 ✓</div>
                                        <div class="text-red-600">객관적 사실만 썼나요?</div>
                                    </div>
                                    <div class="bg-orange-50 p-2 rounded text-xs">
                                        <div class="font-semibold text-orange-700 mb-1">B 체크 ✓</div>
                                        <div class="text-orange-600">그때 든 생각을 썼나요?</div>
                                    </div>
                                    <div class="bg-blue-50 p-2 rounded text-xs">
                                        <div class="font-semibold text-blue-700 mb-1">C 체크 ✓</div>
                                        <div class="text-blue-600">감정과 행동을 썼나요?</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3단계: 새로운 생각 함께 만들기 -->
                        <div id="step3-reframe" class="step-content hidden bg-purple-50 p-4 rounded-lg mb-4">
                            <h4 class="text-lg font-bold text-purple-700 mb-3">✨ 3단계: 새로운 생각 함께 만들기</h4>
                            
                            <!-- 3단계 설명 -->
                            <div class="bg-white p-4 rounded-lg mb-4 border-l-4 border-purple-500">
                                <p class="text-sm text-gray-700 mb-2">
                                    <strong>💡 생각 바꾸기:</strong> 힘들게 만든 생각을 더 현실적이고 도움이 되는 생각으로 바꿔보세요
                                </p>
                                <p class="text-xs text-gray-600">
                                    각 카드에 마우스를 올리면 가이드가 나타나요. 클릭하면 더 자세한 도움을 받을 수 있어요!
                                </p>
                            </div>
                            
                            <!-- 3단계 가이드 카드들 -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="reframe-card reframe-old bg-gray-100 p-4 rounded-lg text-center relative" data-reframe="old">
                                    <div class="text-2xl mb-2">🤔</div>
                                    <div class="font-bold text-gray-700 text-sm mb-1">기존 생각 검토</div>
                                    <div class="text-xs text-gray-600">문제가 된 생각 찾기</div>
                                    
                                    <!-- 툴팁 -->
                                    <div class="reframe-tooltip">
                                        <div class="font-bold text-gray-700 mb-2">🤔 기존 생각 다시 보기</div>
                                        <div class="text-xs text-gray-700 space-y-1">
                                            <div><strong>✓ 확인할 것:</strong></div>
                                            <div>• 2단계 B에서 쓴 생각</div>
                                            <div>• 너무 극단적인 생각은?</div>
                                            <div>• 도움이 안 되는 생각은?</div>
                                            <div class="mt-2"><strong>🔍 찾는 신호:</strong></div>
                                            <div>• "항상", "절대", "완전히"</div>
                                            <div>• "끝났다", "망했다"</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="reframe-card reframe-new bg-purple-100 p-4 rounded-lg text-center relative" data-reframe="new">
                                    <div class="text-2xl mb-2">💜</div>
                                    <div class="font-bold text-purple-700 text-sm mb-1">새로운 생각</div>
                                    <div class="text-xs text-purple-600">현실적이고 도움되는 생각</div>
                                    
                                    <!-- 툴팁 -->
                                    <div class="reframe-tooltip">
                                        <div class="font-bold text-purple-700 mb-2">💜 새로운 생각 만들기</div>
                                        <div class="text-xs text-gray-700 space-y-1">
                                            <div><strong>✓ 포함할 것:</strong></div>
                                            <div>• 현실적이고 균형잡힌 생각</div>
                                            <div>• 도움이 되고 희망적인 생각</div>
                                            <div>• 구체적이고 실현 가능한 생각</div>
                                            <div class="mt-2"><strong>🔍 만드는 방법:</strong></div>
                                            <div>• "부분적으로는...", "때로는..."</div>
                                            <div>• "다음에는...", "배울 수 있어"</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="reframe-card reframe-action bg-cyan-100 p-4 rounded-lg text-center relative" data-reframe="action">
                                    <div class="text-2xl mb-2">🎯</div>
                                    <div class="font-bold text-cyan-700 text-sm mb-1">구체적 행동</div>
                                    <div class="text-xs text-cyan-600">실제로 할 수 있는 일</div>
                                    
                                    <!-- 툴팁 -->
                                    <div class="reframe-tooltip">
                                        <div class="font-bold text-cyan-700 mb-2">🎯 구체적 행동 계획</div>
                                        <div class="text-xs text-gray-700 space-y-1">
                                            <div><strong>✓ 포함할 것:</strong></div>
                                            <div>• 실제로 실행 가능한 행동</div>
                                            <div>• 작고 구체적인 첫 걸음</div>
                                            <div>• 도움받을 수 있는 방법</div>
                                            <div class="mt-2"><strong>🔍 만드는 질문:</strong></div>
                                            <div>• 내일 뭘 해볼까?</div>
                                            <div>• 누구에게 도움을 요청할까?</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 생각 바꾸기 질문들 (기존) -->
                            <div class="bg-yellow-50 p-3 rounded-lg mb-3">
                                <p class="text-sm font-semibold text-yellow-800 mb-2">💡 생각 바꾸기 질문들</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-yellow-700">
                                    <div>• 친한 친구라면 뭐라고 할까?</div>
                                    <div>• 이 생각이 100% 사실일까?</div>
                                    <div>• 다른 가능성은 없을까?</div>
                                    <div>• 1년 후에도 중요할까?</div>
                                </div>
                            </div>
                            
                            <!-- 동적 가이드 영역 -->
                            <div id="reframe-guide-area" class="bg-pink-50 border-2 border-pink-300 rounded-lg p-4 mb-4 hidden">
                                <div id="reframe-guide-content">
                                    <!-- 선택된 영역에 따른 가이드가 여기에 표시 -->
                                </div>
                            </div>
                            
                            <!-- 입력 영역들 -->
                            <div class="space-y-4">
                                <div class="bg-white rounded-lg p-4 border-2 border-gray-200">
                                    <div class="flex items-center justify-between mb-3">
                                        <label class="text-sm font-semibold text-gray-700">💜 B' 새로운 생각</label>
                                        <button id="new-thinking-example-btn" class="bg-purple-500 text-white px-3 py-1 rounded-lg text-xs btn-hover">
                                            💡 예시 보기
                                        </button>
                                    </div>
                                    <textarea id="new-thinking" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                                              placeholder="더 현실적이고 도움이 되는 생각으로 바꿔보세요..."></textarea>
                                    
                                    <!-- 새로운 생각 체크리스트 -->
                                    <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-2">
                                        <div class="bg-purple-50 p-2 rounded text-xs">
                                            <div class="font-semibold text-purple-700 mb-1">현실적 ✓</div>
                                            <div class="text-purple-600">사실에 근거했나요?</div>
                                        </div>
                                        <div class="bg-purple-50 p-2 rounded text-xs">
                                            <div class="font-semibold text-purple-700 mb-1">균형잡힌 ✓</div>
                                            <div class="text-purple-600">극단적이지 않나요?</div>
                                        </div>
                                        <div class="bg-purple-50 p-2 rounded text-xs">
                                            <div class="font-semibold text-purple-700 mb-1">도움되는 ✓</div>
                                            <div class="text-purple-600">희망을 주나요?</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white rounded-lg p-4 border-2 border-gray-200">
                                    <div class="flex items-center justify-between mb-3">
                                        <label class="text-sm font-semibold text-gray-700">🎯 구체적인 도움 방법</label>
                                        <button id="help-suggestions-example-btn" class="bg-cyan-500 text-white px-3 py-1 rounded-lg text-xs btn-hover">
                                            💡 예시 보기
                                        </button>
                                    </div>
                                    <textarea id="help-suggestions" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" 
                                              placeholder="친구가 실제로 할 수 있는 구체적인 행동을 제안해보세요..."></textarea>
                                    
                                    <!-- 구체적 행동 체크리스트 -->
                                    <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-2">
                                        <div class="bg-cyan-50 p-2 rounded text-xs">
                                            <div class="font-semibold text-cyan-700 mb-1">실행 가능 ✓</div>
                                            <div class="text-cyan-600">실제로 할 수 있나요?</div>
                                        </div>
                                        <div class="bg-cyan-50 p-2 rounded text-xs">
                                            <div class="font-semibold text-cyan-700 mb-1">구체적 ✓</div>
                                            <div class="text-cyan-600">명확하고 세부적인가요?</div>
                                        </div>
                                        <div class="bg-cyan-50 p-2 rounded text-xs">
                                            <div class="font-semibold text-cyan-700 mb-1">첫 걸음 ✓</div>
                                            <div class="text-cyan-600">작은 것부터 시작하나요?</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 4단계: 격려하기 -->
                        <div id="step4-encourage" class="step-content hidden bg-pink-50 p-4 rounded-lg">
                            <h4 class="text-lg font-bold text-pink-700 mb-3">🎁 4단계: 따뜻한 격려하기</h4>
                            <div class="space-y-3">
                                <div>
                                    <button id="draw-encouragement-btn" class="bg-pink-500 text-white px-4 py-2 rounded-lg btn-hover mb-2">
                                        🎲 격려 메시지 뽑기
                                    </button>
                                    <div id="encouragement-message" class="bg-white p-3 rounded-lg min-h-[50px] flex items-center justify-center text-pink-700 font-medium">
                                        격려 메시지를 뽑아보세요!
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">💌 나만의 격려 메시지</label>
                                    <textarea id="personal-encouragement" rows="3" class="w-full p-3 border rounded-lg" 
                                              placeholder="친구에게 전하고 싶은 특별한 격려의 말을 써보세요..."></textarea>
                                </div>
                                
                                <!-- 컨설팅 완료 버튼 -->
                                <div class="pt-4 border-t">
                                    <button id="save-consultation-btn" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-lg btn-hover text-lg">
                                        💾 컨설팅 결과 저장하기
                                    </button>
                                    <p class="text-xs text-gray-500 text-center mt-2">
                                        모든 단계의 내용이 정리된 결과물을 이미지로 저장하거나 인쇄할 수 있습니다
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 결과 화면 -->
        <div id="result-screen" class="hidden slide-in">
            <!-- 캡처될 영역 -->
            <div id="printable-consultation" class="bg-gradient-to-br from-yellow-50 via-pink-50 to-purple-50 rounded-2xl shadow-lg p-8 mb-6">
                <div class="text-center mb-8 border-b-2 border-pink-200 pb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">🎉 ABC 컨설팅 완료 보고서</h2>
                    <p class="text-gray-600 mb-4">따뜻한 마음으로 친구를 도와준 컨설팅 결과입니다</p>
                    <div class="text-sm text-gray-500" id="consultation-info">
                        <!-- 컨설턴트/내담자 정보가 여기에 표시 -->
                    </div>
                </div>

                <div id="consultation-summary" class="space-y-6">
                    <!-- 동적으로 생성될 요약 내용 -->
                </div>
                
                <div class="text-center text-sm text-gray-500 mt-8 pt-6 border-t-2 border-pink-200">
                    <p>컨설팅 완료 시간: <span id="completion-time"></span></p>
                    <p class="mt-1">🌟 ABC 통합 컨설팅 도구로 제작되었습니다</p>
                </div>
            </div>
            
            <!-- 버튼들은 캡처 영역 밖에 배치 -->
            <div class="no-print space-y-4">
                <!-- 메인 액션 버튼들 -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="download-image-btn" class="bg-blue-500 text-white font-bold px-8 py-3 rounded-lg btn-hover text-lg">
                        📷 이미지로 저장하기
                    </button>
                    <button id="print-consultation-btn" class="bg-green-500 text-white font-bold px-8 py-3 rounded-lg btn-hover text-lg">
                        🖨️ 인쇄하기 (PDF 저장)
                    </button>
                </div>
                
                <!-- 도움말 -->
                <div class="text-center text-sm text-gray-600 bg-yellow-50 p-4 rounded-lg">
                    <p class="font-semibold mb-2">💡 저장 방법 안내</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <p><strong>📷 이미지 저장:</strong> 컨설팅 결과를 PNG 이미지로 다운로드</p>
                            <p><strong>🖨️ 인쇄하기:</strong> 브라우저 인쇄 창에서 "PDF로 저장" 선택</p>
                        </div>
                        <div>
                            <p><strong>🖼️ 전체화면:</strong> 큰 화면으로 보며 스크린샷 촬영</p>
                            <p><strong>📱 모바일:</strong> 전체화면 후 스크린샷 추천</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">※ 이미지 저장이 안 되는 경우 인쇄 또는 전체화면 기능을 이용해주세요</p>
                </div>
                
                <!-- 추가 액션 버튼들 -->
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button id="switch-and-restart-btn" class="bg-orange-500 text-white font-bold px-6 py-2 rounded-lg btn-hover">
                        🔄 역할 바꿔서 다시하기
                    </button>
                    <button id="new-case-btn" class="bg-purple-500 text-white font-bold px-6 py-2 rounded-lg btn-hover">
                        🆕 새로운 사례로 시작
                    </button>
                    <button id="restart-btn" class="bg-gray-500 text-white font-bold px-6 py-2 rounded-lg btn-hover">
                        🏠 처음으로
                    </button>
                    <button id="fullscreen-btn" class="bg-indigo-500 text-white font-bold px-6 py-2 rounded-lg btn-hover">
                        🖼️ 전체화면 보기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== 데이터 =====
        const sampleCases = [
            { 
                title: "시험 성적이 나빠서 속상해", 
                content: "열심히 공부했는데 시험 성적이 생각보다 많이 안 좋게 나왔어. 부모님께 어떻게 말씀드려야 할지 모르겠고, 친구들과 비교되는 것도 싫어.",
                emotions: ["😞 실망", "😟 걱정", "😳 부끄러움", "😤 좌절감", "😔 자책감", "😨 두려움"]
            },
            { 
                title: "친구가 내 비밀을 다른 사람에게 말했어", 
                content: "가장 친한 친구라고 생각했는데, 내가 말하지 말라고 했던 비밀을 다른 반 애들에게 다 말해버렸어. 너무 배신감이 들고 앞으로 그 친구를 어떻게 대해야 할지 모르겠어.",
                emotions: ["😠 화남", "😔 배신감", "😢 슬픔", "😟 걱정", "😤 억울함", "😞 실망"]
            },
            { 
                title: "새 학급에 적응하기 어려워", 
                content: "새 학기가 시작되고 반이 바뀌었는데, 아직도 친구를 잘 못 사귀었어. 다른 애들은 이미 친해진 것 같은데 나만 혼자인 것 같아서 학교 가기가 싫어져.",
                emotions: ["😔 외로움", "😟 불안함", "😳 부끄러움", "😞 소외감", "😨 두려움", "😤 답답함"]
            },
            { 
                title: "부모님이 자꾸 다른 애와 비교해", 
                content: "엄마가 맨날 사촌 형이나 친구들과 나를 비교해. '누구는 이렇게 잘하는데 너는 왜 못하니?'라고 말씀하시면 기분이 너무 안 좋아. 열심히 하고 있는데 인정받지 못하는 것 같아.",
                emotions: ["😠 화남", "😔 서러움", "😤 억울함", "😞 자괴감", "😟 스트레스", "😢 슬픔"]
            },
            { 
                title: "선생님께 억울하게 혼났어", 
                content: "오늘 수업 시간에 내가 하지도 않은 일로 선생님께 혼났어. 진짜 억울하고 화가 나는데, 변명하면 더 혼날 것 같아서 아무 말도 못했어. 어떻게 해야 할지 모르겠어.",
                emotions: ["😠 화남", "😤 억울함", "😞 답답함", "😟 당황스러움", "😔 무력감", "😨 두려움"]
            },
            { 
                title: "반에서 따돌림을 당하고 있어", 
                content: "몇몇 친구들이 나를 일부러 무시하고 같이 놀지 않으려고 해. 뭘 잘못했는지도 모르겠는데 점점 혼자가 되어가는 것 같아. 학교 가는 게 무서워졌어.",
                emotions: ["😢 슬픔", "😔 외로움", "😨 두려움", "😟 불안함", "😞 우울함", "😤 답답함"]
            },
            { 
                title: "진로를 정하지 못하겠어", 
                content: "중학교에 올라가면서 진로에 대해 생각해보라고 하는데, 정말 뭘 하고 싶은지 모르겠어. 친구들은 이미 꿈이 정해진 것 같은데 나만 아무것도 모르는 것 같아서 답답해.",
                emotions: ["😟 불안함", "😤 답답함", "😔 조급함", "😞 막막함", "😳 부끄러움", "😨 걱정"]
            },
            { 
                title: "게임 때문에 부모님과 자꾸 싸워", 
                content: "게임을 너무 오래 한다고 부모님이 화내시는데, 친구들과 함께 하는 게임이라 중간에 그만둘 수가 없어. 그런데 계속 싸우니까 집에 있는 것도 불편하고 스트레스가 많이 쌓여.",
                emotions: ["😠 화남", "😤 답답함", "😟 스트레스", "😔 죄책감", "😞 고민됨", "😨 걱정"]
            },
            { 
                title: "발표할 때마다 너무 떨려", 
                content: "수업 시간에 발표를 해야 할 때마다 심장이 너무 빨리 뛰고 목소리가 떨려. 다른 애들이 나를 어떻게 생각할지 걱정되고, 실수할까 봐 무서워서 발표가 있는 날은 학교에 가기 싫어져.",
                emotions: ["😨 두려움", "😟 불안함", "😳 부끄러움", "😞 긴장감", "😔 걱정", "😤 스트레스"]
            },
            { 
                title: "용돈이 부족해서 고민이야", 
                content: "친구들은 다 새로운 걸 사는데 나는 용돈이 부족해서 못 사겠어. 부모님께 더 달라고 하기는 어려운 상황이고, 친구들과 함께 할 수 없는 일들이 많아져서 소외감을 느껴.",
                emotions: ["😔 소외감", "😞 서러움", "😟 걱정", "😤 답답함", "😳 부끄러움", "😢 속상함"]
            },
            { 
                title: "형제자매와 자꾸 싸워", 
                content: "동생(형)과 맨날 사소한 일로 싸워. 부모님은 항상 내가 양보하라고 하시는데 그것도 억울하고, 집에서 편하게 쉴 수가 없어서 짜증이 많이 나.",
                emotions: ["😠 화남", "😤 억울함", "😞 짜증남", "😔 스트레스", "😟 피곤함", "😢 속상함"]
            },
            { 
                title: "몸무게 때문에 스트레스받아", 
                content: "요즘 몸무게가 늘어서 걱정이야. 다른 친구들과 비교하게 되고, 체육 시간이나 수영장 갈 때 부끄러워. 다이어트를 해보려고 하는데 쉽지 않아서 더 스트레스받아.",
                emotions: ["😔 스트레스", "😳 부끄러움", "😞 자괴감", "😟 걱정", "😤 답답함", "😢 속상함"]
            },
            { 
                title: "휴대폰을 잃어버렸어", 
                content: "어제 휴대폰을 잃어버렸는데, 부모님께 아직 말씀드리지 못했어. 화내실까 봐 무서우면서도 새로 사달라고 하기는 부담스러워. 친구들과 연락도 못하겠고 어떻게 해야 할지 모르겠어.",
                emotions: ["😨 두려움", "😟 걱정", "😞 당황스러움", "😔 죄책감", "😤 답답함", "😳 부끄러움"]
            },
            { 
                title: "클럽활동에서 실수했어", 
                content: "오늘 동아리 활동에서 큰 실수를 했어. 다른 멤버들에게 피해를 줬는데, 어떻게 사과해야 할지 모르겠어. 내 실수 때문에 팀 전체 분위기가 안 좋아진 것 같아서 미안하고 부담스러워.",
                emotions: ["😔 죄책감", "😞 미안함", "😟 걱정", "😳 부끄러움", "😤 자책감", "😨 두려움"]
            },
            { 
                title: "좋아하는 친구가 있는데 고백할 용기가 안 나", 
                content: "좋아하는 친구가 있는데 고백할 용기가 없어. 거절당할까 봐 무서우면서도, 지금처럼 친구로 지내는 것도 좋은데 괜히 어색해질까 봐 걱정돼. 어떻게 해야 할지 정말 모르겠어.",
                emotions: ["😨 두려움", "😟 설렘", "😞 고민됨", "😳 부끄러움", "😔 걱정", "😤 답답함"]
            },
            { 
                title: "알바를 시작했는데 힘들어", 
                content: "용돈을 벌기 위해 알바를 시작했는데 생각보다 힘들어. 학업과 병행하기 어렵고, 가끔 손님들이 불친절할 때도 있어서 스트레스받아. 그만둘까 생각하는데 돈도 필요해서 고민이야.",
                emotions: ["😔 스트레스", "😞 피곤함", "😟 걱정", "😤 답답함", "😠 짜증남", "😨 부담감"]
            },
            { 
                title: "SNS에서 악플을 받았어", 
                content: "내가 올린 사진에 누가 악플을 달았어. 익명이라서 누군지 모르겠는데 내용이 너무 상처가 돼. SNS를 하기 무서워지고, 혹시 아는 사람이 쓴 건 아닐까 의심도 돼.",
                emotions: ["😢 상처받음", "😠 화남", "😨 두려움", "😟 불안함", "😔 우울함", "😞 속상함"]
            },
            { 
                title: "반장 선거에서 떨어졌어", 
                content: "반장 선거에 나갔는데 떨어졌어. 나름 열심히 준비했는데 다른 친구가 당선돼서 속상해. 친구들이 나를 어떻게 생각하는지도 궁금하고, 다음에 또 도전해야 할지 고민돼.",
                emotions: ["😞 실망", "😔 속상함", "😟 걱정", "😳 부끄러움", "😤 아쉬움", "😢 서운함"]
            },
            { 
                title: "이사 때문에 친구들과 헤어져야 해", 
                content: "아빠 직장 때문에 다른 지역으로 이사를 가게 됐어. 여기 친구들과 헤어지는 게 너무 싫고, 새로운 곳에서 잘 적응할 수 있을지 걱정돼. 어떻게 이별 인사를 해야 할지도 모르겠어.",
                emotions: ["😢 슬픔", "😔 아쉬움", "😟 걱정", "😨 두려움", "😞 우울함", "😤 서운함"]
            },
            { 
                title: "학원 때문에 친구들과 놀 시간이 없어", 
                content: "부모님이 학원을 너무 많이 보내셔서 친구들과 놀 시간이 없어. 매일 학원만 다니니까 재미도 없고, 친구들과 점점 멀어지는 것 같아서 외로워. 그렇다고 부모님께 그만두겠다고 말하기도 어려워.",
                emotions: ["😔 외로움", "😞 피곤함", "😟 스트레스", "😤 답답함", "😢 속상함", "😨 부담감"]
            },
            { 
                title: "급식이 맛없어서 먹기 싫어", 
                content: "요즘 급식이 정말 맛없어서 먹기가 싫어. 친구들도 다 맛없다고 하는데 어떻게 해야 할지 모르겠어. 그냥 굶으면 오후에 배고프고, 도시락을 싸달라고 하기도 부담스러워.",
                emotions: ["😤 짜증남", "😞 속상함", "😟 걱정", "😔 스트레스", "😨 부담스러움", "😠 불만"]
            },
            { 
                title: "체육시간이 너무 부끄러워", 
                content: "체육시간에 운동을 못해서 항상 부끄러워. 친구들은 다 잘하는데 나만 못하는 것 같아서 체육시간이 되면 학교에 가기 싫어져. 선생님께 말씀드리고 싶은데 용기가 안 나.",
                emotions: ["😳 부끄러움", "😞 자괴감", "😟 걱정", "😔 스트레스", "😨 두려움", "😤 답답함"]
            },
            { 
                title: "교실에서 냄새가 날까 봐 걱정돼", 
                content: "요즘 사춘기라서 체취가 생긴 것 같아. 친구들이 나 때문에 냄새가 난다고 생각할까 봐 걱정돼. 데오드란트를 써보려고 하는데 부모님께 말하기가 부끄러워.",
                emotions: ["😳 부끄러움", "😟 걱정", "😞 스트레스", "😨 두려움", "😔 위축감", "😤 민감함"]
            },
            { 
                title: "수학을 도저히 모르겠어", 
                content: "수학 수업을 아무리 들어도 이해가 안 돼. 선생님께 질문하고 싶은데 바보같아 보일까 봐 걱정돼. 친구들한테 물어보기도 민망하고, 수학 시간만 되면 스트레스받아.",
                emotions: ["😞 좌절감", "😟 걱정", "😤 답답함", "😔 스트레스", "😳 부끄러움", "😨 두려움"]
            },
            { 
                title: "반 아이들이 시끄러워서 집중이 안 돼", 
                content: "우리 반 아이들이 수업시간에도 너무 시끄러워서 집중이 안 돼. 선생님도 별로 주의를 안 주시고, 공부하려고 하는데 방해가 돼서 짜증나. 어떻게 해야 할지 모르겠어.",
                emotions: ["😠 짜증남", "😤 답답함", "😞 스트레스", "😔 피곤함", "😟 걱정", "😨 불안함"]
            },
            { 
                title: "키가 작아서 놀림받아", 
                content: "친구들이 내 키가 작다고 자꾸 놀려. 농담이라고 하는데 들을 때마다 기분이 안 좋아. 키는 어쩔 수 없는 건데 왜 놀리는 건지 모르겠어. 키 크는 방법이 있을까?",
                emotions: ["😢 상처받음", "😠 화남", "😞 자괴감", "😔 서러움", "😟 걱정", "😤 억울함"]
            },
            { 
                title: "생리 때문에 체육을 빠지고 싶어", 
                content: "생리할 때 체육수업 참여하기가 너무 힘들어. 선생님께 말씀드리기도 부끄럽고, 친구들 앞에서 이야기하기도 민망해. 어떻게 자연스럽게 빠질 수 있을까?",
                emotions: ["😳 부끄러움", "😞 불편함", "😟 걱정", "😔 스트레스", "😨 두려움", "😤 답답함"]
            },
            { 
                title: "부모님이 이혼하실 것 같아", 
                content: "요즘 부모님이 자주 싸우셔서 혹시 이혼하시는 건 아닌지 걱정돼. 집에 있을 때마다 분위기가 안 좋고, 나 때문에 싸우시는 건 아닌지 걱정돼. 어떻게 해야 할지 모르겠어.",
                emotions: ["😨 두려움", "😟 걱정", "😢 슬픔", "😔 불안함", "😞 죄책감", "😤 스트레스"]
            },
            { 
                title: "반려동물이 아파서 걱정돼", 
                content: "우리 강아지가 요즘 아픈 것 같아서 걱정이야. 병원에 가야 하는데 돈이 많이 들까 봐 부모님께 말씀드리기가 부담스러워. 혹시 심각한 병은 아닐까 걱정돼.",
                emotions: ["😟 걱정", "😢 슬픔", "😞 불안함", "😔 스트레스", "😨 두려움", "😤 답답함"]
            },
            { 
                title: "선생님이 편애하는 것 같아", 
                content: "선생님이 특정 학생들만 좋아하시는 것 같아. 똑같은 실수를 해도 어떤 애는 혼내고 어떤 애는 안 혼내셔서 억울해. 공평하지 않은 것 같은데 어떻게 말씀드려야 할까?",
                emotions: ["😤 억울함", "😠 화남", "😞 속상함", "😔 서러움", "😟 걱정", "😨 두려움"]
            },
            { 
                title: "치과 치료가 무서워", 
                content: "치아가 아픈데 치과 가는 게 너무 무서워. 마취 주사도 무섭고 드릴 소리도 무서워서 계속 미루고 있어. 그런데 더 아파지는 것 같아서 어떻게 해야 할지 모르겠어.",
                emotions: ["😨 두려움", "😟 걱정", "😞 불안함", "😔 스트레스", "😤 답답함", "😢 아픔"]
            },
            { 
                title: "어른스럽지 못한 것 같아", 
                content: "친구들은 다 어른스러운데 나만 어린애 같은 느낌이야. 말하는 것도 행동하는 것도 유치한 것 같아서 부끄러워. 어떻게 하면 좀 더 어른스러워질 수 있을까?",
                emotions: ["😳 부끄러움", "😞 자괴감", "😟 걱정", "😔 위축감", "😤 답답함", "😨 두려움"]
            },
            { 
                title: "야동을 봤는데 죄책감이 들어", 
                content: "친구가 보여준 야동을 봤는데 계속 죄책감이 들어. 부모님이 알면 실망하실 것 같고, 이런 걸 보는 게 나쁜 건 아닌지 걱정돼. 어떻게 해야 할지 모르겠어.",
                emotions: ["😔 죄책감", "😟 걱정", "😳 부끄러움", "😞 혼란스러움", "😨 두려움", "😤 답답함"]
            },
            { 
                title: "남자친구/여자친구를 사귀고 싶어", 
                content: "친구들은 다 연애를 하는데 나만 혼자인 것 같아서 외로워. 좋아하는 사람은 있는데 어떻게 다가가야 할지 모르겠어. 고백하면 거절당할까 봐 무섭기도 하고.",
                emotions: ["😔 외로움", "😟 걱정", "😞 설렘", "😨 두려움", "😳 부끄러움", "😤 답답함"]
            },
            { 
                title: "부모님께 성적표를 못 보여드리겠어", 
                content: "이번 성적표가 너무 안 좋게 나와서 부모님께 보여드리기가 무서워. 열심히 했다고 말씀드려도 믿지 않으실 것 같고, 실망하실 생각하니까 집에 가기가 싫어.",
                emotions: ["😨 두려움", "😞 죄책감", "😟 걱정", "😔 스트레스", "😤 답답함", "😢 속상함"]
            },
            { 
                title: "밤에 무서운 생각이 계속 들어", 
                content: "밤에 잠들기 전에 무서운 생각들이 계속 떠올라. 귀신이나 도둑 같은 생각이 들어서 잠이 안 와. 부모님께 말씀드리기도 부끄럽고, 어떻게 해야 할지 모르겠어.",
                emotions: ["😨 두려움", "😟 불안함", "😞 걱정", "😔 스트레스", "😳 부끄러움", "😤 답답함"]
            },
            { 
                title: "반에서 왕따를 시키는 걸 봤어", 
                content: "우리 반에서 한 친구를 왕따시키는 걸 봤는데 어떻게 해야 할지 모르겠어. 도와주고 싶은데 나도 같이 왕따될까 봐 무섭고, 그냥 보고만 있자니 양심에 걸려.",
                emotions: ["😟 걱정", "😞 죄책감", "😨 두려움", "😔 갈등", "😤 답답함", "😢 안타까움"]
            },
            { 
                title: "용모에 자신이 없어", 
                content: "거울을 볼 때마다 내 얼굴이 마음에 안 들어. 친구들은 다 예쁘고 잘생긴 것 같은데 나만 못생긴 것 같아서 자신감이 없어져. 성형수술 같은 생각도 들어.",
                emotions: ["😞 자괴감", "😔 위축감", "😟 걱정", "😳 부끄러움", "😤 답답함", "😢 속상함"]
            },
            { 
                title: "선배들이 무서워", 
                content: "학교 선배들이 무서워서 복도를 지날 때마다 긴장돼. 괜히 눈 마주치면 뭐라고 할까 봐 걱정되고, 혹시 시비를 걸까 봐 무서워. 어떻게 해야 할지 모르겠어.",
                emotions: ["😨 두려움", "😟 걱정", "😞 긴장감", "😔 스트레스", "😤 위축감", "😳 부끄러움"]
            },
            { 
                title: "컴퓨터 게임에서 계속 져서 속상해", 
                content: "친구들과 게임을 할 때마다 내가 제일 못해서 속상해. 연습을 해도 실력이 늘지 않는 것 같고, 친구들한테 민폐가 되는 것 같아서 같이 게임하기가 부담스러워.",
                emotions: ["😞 좌절감", "😔 자괴감", "😟 걱정", "😤 답답함", "😢 속상함", "😨 부담감"]
            },
            { 
                title: "화장을 해보고 싶은데 부모님이 반대해", 
                content: "친구들은 다 화장을 하는데 나만 못하게 해서 속상해. 부모님이 어리다고 안 된다고 하시는데, 친구들과 다른 것 같아서 소외감이 들어. 어떻게 설득해야 할까?",
                emotions: ["😞 속상함", "😔 소외감", "😟 걱정", "😤 답답함", "😨 부담감", "😢 서운함"]
            },
            { 
                title: "학교에서 돈을 잃어버렸어", 
                content: "오늘 점심값으로 가져온 돈을 잃어버렸어. 어디서 떨어뜨렸는지 모르겠고, 혹시 누가 가져간 건 아닌지 의심스러워. 부모님께 말씀드리기도 부끄럽고 어떻게 해야 할까?",
                emotions: ["😟 걱정", "😞 당황스러움", "😔 속상함", "😳 부끄러움", "😤 답답함", "😨 두려움"]
            },
            { 
                title: "반 친구가 내 물건을 자꾸 빌려가", 
                content: "한 친구가 내 물건을 자꾸 빌려가는데 돌려달라고 말하기가 어려워. 거절하면 인색하다고 생각할까 봐 걱정되고, 그렇다고 계속 빌려주기도 부담스러워.",
                emotions: ["😟 걱정", "😞 부담스러움", "😤 답답함", "😔 스트레스", "😨 두려움", "😳 난처함"]
            },
            { 
                title: "숙제를 깜빡해서 거짓말했어", 
                content: "숙제를 깜빡하고 안 해와서 거짓말로 아프다고 했어. 선생님께 거짓말한 게 계속 마음에 걸리고, 들킬까 봐 걱정돼. 어떻게 해야 할지 모르겠어.",
                emotions: ["😔 죄책감", "😟 걱정", "😞 후회", "😨 두려움", "😤 답답함", "😳 부끄러움"]
            },
            { 
                title: "친구들이 내 뒤에서 나쁘게 말하는 것 같아", 
                content: "친구들이 내가 없을 때 나에 대해 안 좋게 이야기하는 것 같아. 확실하지는 않지만 그런 느낌이 들어서 친구들과 있을 때 불편해. 어떻게 확인해야 할까?",
                emotions: ["😟 걱정", "😞 불안함", "😔 의심", "😤 답답함", "😢 속상함", "😨 두려움"]
            },
            { 
                title: "성교육 시간이 너무 부끄러워", 
                content: "학교에서 성교육을 하는데 너무 부끄러워서 듣기가 힘들어. 중요한 내용인 건 알겠는데 친구들 앞에서 그런 이야기를 하니까 얼굴이 빨개져. 어떻게 해야 할까?",
                emotions: ["😳 부끄러움", "😞 민망함", "😟 걱정", "😔 불편함", "😤 답답함", "😨 긴장감"]
            },
            { 
                title: "부모님이 내 일기를 읽으신 것 같아", 
                content: "부모님이 내 일기를 몰래 읽으신 것 같아. 확실하지는 않지만 그런 느낌이 들어서 더 이상 일기를 쓰기가 불편해. 프라이버시를 침해받는 느낌이라 속상해.",
                emotions: ["😠 화남", "😞 속상함", "😟 걱정", "😤 억울함", "😔 불편함", "😨 불안함"]
            },
            { 
                title: "학교 급식 당번이 너무 힘들어", 
                content: "급식 당번 하는 게 너무 힘들어. 무거운 것도 들어야 하고 뒷정리도 해야 하는데, 다른 애들은 제대로 안 도와줘서 혼자 하는 것 같아. 어떻게 해야 할까?",
                emotions: ["😞 피곤함", "😤 짜증남", "😔 스트레스", "😟 걱정", "😠 억울함", "😨 부담감"]
            },
            { 
                title: "반 친구가 내 약점을 알고 놀려", 
                content: "한 친구가 내 약점을 알고 계속 놀려. 다른 친구들 앞에서 그런 이야기를 하면 너무 부끄럽고 화가 나. 그만하라고 말해도 장난이라고 하면서 계속해.",
                emotions: ["😠 화남", "😳 부끄러움", "😞 속상함", "😤 억울함", "😔 스트레스", "😨 두려움"]
            }
        ];

        const encouragementMessages = [
            "너의 마음을 이해해주는 사람이 여기 있어 ✨",
            "힘든 시간도 지나갈 거야, 조금만 더 힘내자 💪",
            "너는 생각보다 훨씬 강한 사람이야 🌟",
            "완벽하지 않아도 괜찮아, 그것이 바로 너니까 🤗",
            "오늘 하루도 최선을 다한 너에게 박수를 보내 👏",
            "어려운 일이 있어도 너라면 잘 헤쳐나갈 수 있어 🚀",
            "네가 특별한 이유는 너만의 고유함이 있기 때문이야 🎈",
            "실수해도 괜찮아, 그것도 성장의 과정이니까 📈"
        ];

        // ===== 상태 관리 =====
        let currentStep = 1;
        let currentCase = null;
        let isConsultant = true; // true: 컨설턴트 역할, false: 내담자 역할
        let visitedSteps = [1]; // 방문한 단계들 추적
        let selectedEmotions = []; // 선택된 감정들
        let consultationData = {};
        let displayedCasesIndices = []; // 현재 화면에 표시된 사례들의 인덱스
        let selectedCaseIndex = null; // 선택된 사례의 인덱스
        let autoSaveTimer = null; // 자동저장 타이머

        // ===== 자동 저장 기능 =====
        function saveToLocalStorage() {
            try {
                const saveData = {
                    currentStep,
                    currentCase,
                    isConsultant,
                    visitedSteps,
                    selectedEmotions,
                    selectedCaseIndex,
                    displayedCasesIndices,
                    formData: {
                        consultantName: document.getElementById('consultant-name')?.value || '',
                        consultantClass: document.getElementById('consultant-class')?.value || '',
                        clientName: document.getElementById('client-name')?.value || '',
                        clientClass: document.getElementById('client-class')?.value || '',
                        customTitle: document.getElementById('custom-title')?.value || '',
                        customContent: document.getElementById('custom-content')?.value || '',
                        empathyText: document.getElementById('empathy-text')?.value || '',
                        abcAnalysis: document.getElementById('abc-analysis')?.value || '',
                        newThinking: document.getElementById('new-thinking')?.value || '',
                        helpSuggestions: document.getElementById('help-suggestions')?.value || '',
                        personalEncouragement: document.getElementById('personal-encouragement')?.value || ''
                    },
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                localStorage.setItem('abc_consulting_data', JSON.stringify(saveData));
                console.log('데이터 자동 저장됨:', new Date().toLocaleTimeString());
                
                // 저장 상태 표시 (선택적)
                showSaveStatus('💾 자동 저장됨');
            } catch (error) {
                console.error('저장 실패:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('abc_consulting_data');
                if (!savedData) return false;

                const data = JSON.parse(savedData);
                console.log('저장된 데이터 발견:', data);

                // 저장된 시간이 24시간 이내인지 확인
                const savedTime = new Date(data.timestamp);
                const now = new Date();
                const hoursDiff = (now - savedTime) / (1000 * 60 * 60);
                
                if (hoursDiff > 24) {
                    console.log('저장된 데이터가 24시간 이상 경과하여 삭제');
                    localStorage.removeItem('abc_consulting_data');
                    return false;
                }

                // 사용자에게 복구 여부 확인
                const restoreConfirm = confirm(
                    `💾 이전에 작업하던 내용이 발견되었어요!\n\n` +
                    `저장 시간: ${savedTime.toLocaleString('ko-KR')}\n` +
                    `복구하시겠어요?\n\n` +
                    `• 확인: 이전 작업 이어서 하기\n` +
                    `• 취소: 새로 시작하기`
                );

                if (!restoreConfirm) {
                    localStorage.removeItem('abc_consulting_data');
                    return false;
                }

                // 데이터 복구
                currentStep = data.currentStep || 1;
                currentCase = data.currentCase;
                isConsultant = data.isConsultant !== undefined ? data.isConsultant : true;
                visitedSteps = data.visitedSteps || [1];
                selectedEmotions = data.selectedEmotions || [];
                selectedCaseIndex = data.selectedCaseIndex;
                displayedCasesIndices = data.displayedCasesIndices || [];

                // 폼 데이터 복구
                if (data.formData) {
                    setTimeout(() => {
                        const elements = {
                            'consultant-name': data.formData.consultantName,
                            'consultant-class': data.formData.consultantClass,
                            'client-name': data.formData.clientName,
                            'client-class': data.formData.clientClass,
                            'custom-title': data.formData.customTitle,
                            'custom-content': data.formData.customContent,
                            'empathy-text': data.formData.empathyText,
                            'abc-analysis': data.formData.abcAnalysis,
                            'new-thinking': data.formData.newThinking,
                            'help-suggestions': data.formData.helpSuggestions,
                            'personal-encouragement': data.formData.personalEncouragement
                        };

                        Object.entries(elements).forEach(([id, value]) => {
                            const element = document.getElementById(id);
                            if (element && value) {
                                element.value = value;
                            }
                        });
                    }, 100);
                }

                showSaveStatus('✅ 이전 작업 복구됨!', 3000);
                return true;
            } catch (error) {
                console.error('데이터 복구 실패:', error);
                localStorage.removeItem('abc_consulting_data');
                return false;
            }
        }

        function showSaveStatus(message, duration = 2000) {
            // 기존 상태 메시지 제거
            const existingStatus = document.getElementById('save-status');
            if (existingStatus) {
                existingStatus.remove();
            }

            // 새 상태 메시지 생성
            const statusDiv = document.createElement('div');
            statusDiv.id = 'save-status';
            statusDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm font-medium';
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);

            // 애니메이션 효과
            statusDiv.style.opacity = '0';
            statusDiv.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                statusDiv.style.transition = 'all 0.3s ease';
                statusDiv.style.opacity = '1';
                statusDiv.style.transform = 'translateY(0)';
            }, 10);

            // 자동 제거
            setTimeout(() => {
                statusDiv.style.opacity = '0';
                statusDiv.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.parentNode.removeChild(statusDiv);
                    }
                }, 300);
            }, duration);
        }

        function startAutoSave() {
            // 기존 타이머 정리
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
            }

            // 5초마다 자동 저장
            autoSaveTimer = setInterval(() => {
                saveToLocalStorage();
            }, 5000);
        }

        function stopAutoSave() {
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
                autoSaveTimer = null;
            }
        }

        function clearSavedData() {
            localStorage.removeItem('abc_consulting_data');
            console.log('저장된 데이터 삭제됨');
        }

        // 페이지 떠나기 전 경고
        function setupBeforeUnloadWarning() {
            window.addEventListener('beforeunload', (e) => {
                // 작업 중인 내용이 있으면 경고
                const hasWork = 
                    document.getElementById('empathy-text')?.value?.trim() ||
                    document.getElementById('abc-analysis')?.value?.trim() ||
                    document.getElementById('new-thinking')?.value?.trim() ||
                    document.getElementById('help-suggestions')?.value?.trim() ||
                    document.getElementById('personal-encouragement')?.value?.trim();
                
                if (hasWork) {
                    e.preventDefault();
                    e.returnValue = '작업 중인 내용이 있습니다. 정말 페이지를 떠나시겠어요?';
                    return e.returnValue;
                }
            });
        }

        // ===== DOM 요소 =====
        const screens = {
            start: document.getElementById('start-screen'),
            roleplay: document.getElementById('roleplay-screen'),
            result: document.getElementById('result-screen')
        };

        const elements = {
            // 시작 화면
            randomMode: document.getElementById('random-mode'),
            customMode: document.getElementById('custom-mode'),
            randomCaseArea: document.getElementById('random-case-area'),
            customCaseArea: document.getElementById('custom-case-area'),
            shuffleCasesBtn: document.getElementById('shuffle-cases-btn'),
            caseDisplay: document.getElementById('selected-case-display'),
            customTitle: document.getElementById('custom-title'),
            customContent: document.getElementById('custom-content'),
            startRoleplayBtn: document.getElementById('start-roleplay-btn'),
            
            // 역할극 화면
            currentStep: document.getElementById('current-step'),
            stepDesc: document.getElementById('step-desc'),
            roleDisplay: document.getElementById('role-display'),
            currentConsultant: document.getElementById('current-consultant'),
            stepGuide: document.getElementById('step-guide'),
            nextStepBtn: document.getElementById('next-step-btn'),
            prevStepBtn: document.getElementById('prev-step-btn'),
            switchRolesBtn: document.getElementById('switch-roles-btn'),
            
            // 사례 표시
            displayedTitle: document.getElementById('displayed-title'),
            displayedContent: document.getElementById('displayed-content'),
            
            // 각 단계 요소들
            step1: document.getElementById('step1-empathy'),
            step2: document.getElementById('step2-abc'),
            step3: document.getElementById('step3-reframe'),
            step4: document.getElementById('step4-encourage'),
            
            // 결과 화면
            consultationSummary: document.getElementById('consultation-summary'),
            downloadImageBtn: document.getElementById('download-image-btn'),
            printConsultationBtn: document.getElementById('print-consultation-btn'),
            saveConsultationBtn: document.getElementById('save-consultation-btn'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            switchAndRestartBtn: document.getElementById('switch-and-restart-btn'),
            newCaseBtn: document.getElementById('new-case-btn'),
            restartBtn: document.getElementById('restart-btn')
        };

        // ===== 유틸리티 함수 =====
        function showScreen(screenName) {
            console.log('화면 전환:', screenName);
            
            // 모든 화면 숨기기
            Object.values(screens).forEach(screen => {
                if (screen) {
                    screen.classList.add('hidden');
                    screen.classList.remove('slide-in');
                }
            });
            
            // 대상 화면 보이기
            const targetScreen = screens[screenName];
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                targetScreen.classList.add('slide-in');
                console.log('화면 전환 완료:', screenName);
            } else {
                console.error('화면을 찾을 수 없음:', screenName);
            }
        }

        // ===== 사례 관리 =====
        function generateRandomCases(count = 6) {
            // 중복 없이 랜덤한 사례들 선택
            const indices = [];
            while (indices.length < count && indices.length < sampleCases.length) {
                const randomIndex = Math.floor(Math.random() * sampleCases.length);
                if (!indices.includes(randomIndex)) {
                    indices.push(randomIndex);
                }
            }
            displayedCasesIndices = indices;
            renderCaseCards();
        }

        function renderCaseCards() {
            const container = document.getElementById('case-cards-container');
            if (!container) return;

            container.innerHTML = '';

            displayedCasesIndices.forEach((caseIndex, displayIndex) => {
                const caseData = sampleCases[caseIndex];
                const isSelected = selectedCaseIndex === caseIndex;

                const card = document.createElement('div');
                card.className = `case-card bg-white p-4 rounded-lg shadow-md hover:shadow-lg ${isSelected ? 'selected' : ''}`;
                card.innerHTML = `
                    <div class="text-sm font-semibold text-gray-800 mb-2 line-clamp-2">
                        ${caseData.title}
                    </div>
                    <div class="text-xs text-gray-600 line-clamp-3 leading-relaxed">
                        ${caseData.content.length > 60 ? caseData.content.substring(0, 60) + '...' : caseData.content}
                    </div>
                    <div class="mt-2 text-xs">
                        <span class="text-gray-500">😔 💭 🤔</span>
                    </div>
                `;

                card.addEventListener('click', () => selectCase(caseIndex));
                container.appendChild(card);
            });
        }

        function selectCase(caseIndex) {
            selectedCaseIndex = caseIndex;
            currentCase = sampleCases[caseIndex];
            
            // 카드 선택 상태 업데이트
            renderCaseCards();
            
            // 선택된 사례 표시
            updateSelectedCaseDisplay();
            
            // 자동 저장
            saveToLocalStorage();
        }

        function updateSelectedCaseDisplay() {
            const display = document.getElementById('selected-case-display');
            const content = document.getElementById('selected-case-content');
            
            if (!display || !content) return;
            
            if (currentCase) {
                display.classList.remove('hidden');
                content.innerHTML = `
                    <div class="font-semibold text-lg mb-2">${currentCase.title}</div>
                    <div class="text-sm leading-relaxed">${currentCase.content}</div>
                `;
            } else {
                display.classList.add('hidden');
            }
        }

        function shuffleCases() {
            selectedCaseIndex = null;
            currentCase = null;
            generateRandomCases(6);
            updateSelectedCaseDisplay();
        }

        function drawRandomCase() {
            // 레거시 함수 - 호환성을 위해 유지
            const randomIndex = Math.floor(Math.random() * sampleCases.length);
            selectCase(randomIndex);
        }

        function useCustomCase() {
            const title = elements.customTitle.value.trim();
            const content = elements.customContent.value.trim();
            
            if (title && content) {
                // 커스텀 사례는 기본 감정들로 설정
                currentCase = { 
                    title, 
                    content,
                    emotions: ["😢 슬픔", "😠 화남", "😟 걱정", "😤 답답함", "😔 외로움", "😨 두려움"]
                };
            } else {
                currentCase = null; // 불완전한 입력시 null로 설정
            }
        }

        // ===== 감정 관리 =====
        function updateRecommendedEmotions() {
            const container = document.getElementById('recommended-emotions');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!currentCase || !currentCase.emotions) {
                // 기본 감정들 표시
                const defaultEmotions = ["😢 슬픔", "😠 화남", "😟 걱정", "😤 답답함", "😔 외로움", "😨 두려움"];
                defaultEmotions.forEach(emotion => {
                    const button = document.createElement('button');
                    button.className = 'emotion-btn p-2 border-2 border-gray-300 rounded-lg hover:border-green-500 text-xs transition-all';
                    button.textContent = emotion;
                    button.onclick = () => toggleEmotion(emotion, button);
                    container.appendChild(button);
                });
                return;
            }
            
            currentCase.emotions.forEach(emotion => {
                const button = document.createElement('button');
                button.className = 'emotion-btn p-2 border-2 border-gray-300 rounded-lg hover:border-green-500 text-xs transition-all';
                button.textContent = emotion;
                button.onclick = () => toggleEmotion(emotion, button);
                container.appendChild(button);
            });
        }

        function toggleEmotion(emotion, button) {
            if (selectedEmotions.includes(emotion)) {
                // 감정 제거
                selectedEmotions = selectedEmotions.filter(e => e !== emotion);
                button.classList.remove('selected');
            } else {
                // 감정 추가
                selectedEmotions.push(emotion);
                button.classList.add('selected');
            }
            updateSelectedEmotionsDisplay();
            saveToLocalStorage(); // 자동 저장
        }

        function addDirectEmotion() {
            const input = document.getElementById('direct-emotion-input');
            const emotion = input.value.trim();
            
            if (!emotion) {
                alert('감정을 입력해주세요!');
                return;
            }
            
            if (selectedEmotions.includes(emotion)) {
                alert('이미 선택된 감정입니다!');
                input.value = '';
                return;
            }
            
            selectedEmotions.push(emotion);
            input.value = '';
            updateSelectedEmotionsDisplay();
            saveToLocalStorage(); // 자동 저장
        }

        function removeEmotion(emotion) {
            selectedEmotions = selectedEmotions.filter(e => e !== emotion);
            updateSelectedEmotionsDisplay();
            
            // 추천 감정 버튼도 업데이트
            const buttons = document.querySelectorAll('.emotion-btn');
            buttons.forEach(btn => {
                if (btn.textContent === emotion) {
                    btn.classList.remove('selected');
                }
            });
            
            saveToLocalStorage(); // 자동 저장
        }

        function updateSelectedEmotionsDisplay() {
            const container = document.getElementById('selected-emotions-list');
            
            if (selectedEmotions.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-500">감정을 선택하거나 입력해주세요</span>';
                return;
            }
            
            container.innerHTML = selectedEmotions.map(emotion => `
                <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1">
                    ${emotion}
                    <button onclick="removeEmotion('${emotion}')" class="text-green-600 hover:text-green-800 ml-1">
                        ✕
                    </button>
                </span>
            `).join('');
        }

        // ===== 3단계 도우미 =====
        function generateReframeGuide(reframeType) {
            if (!currentCase) return '';
            
            const caseTitle = currentCase.title;
            
            const guides = {
                'old': {
                    title: '🤔 기존 생각 다시 살펴보기',
                    questions: [
                        '2단계에서 쓴 생각 중 어떤 것이 문제가 될까요?',
                        '너무 극단적이거나 "항상", "절대" 같은 말이 들어있나요?',
                        '이 생각이 도움이 되고 있나요, 방해가 되고 있나요?',
                        '만약 친구가 이런 생각을 한다면 뭐라고 말해줄까요?'
                    ],
                    example: generateReframeExample(caseTitle, 'old'),
                    tips: [
                        '💡 흑백논리: "항상 실패해", "완전히 망했어"',
                        '💡 파국화: "끝났다", "더 이상 희망이 없어"',
                        '💡 감정추론: "기분이 나쁘니까 정말 나쁜 일이야"'
                    ]
                },
                'new': {
                    title: '💜 새롭고 도움이 되는 생각 만들기',
                    questions: [
                        '이 상황에서 더 현실적인 생각은 뭘까요?',
                        '부분적으로나 때로는 다른 가능성은 없을까요?',
                        '이 경험에서 배울 수 있는 것은 무엇일까요?',
                        '1년 후의 나라면 지금 나에게 뭐라고 말해줄까요?'
                    ],
                    example: generateReframeExample(caseTitle, 'new'),
                    tips: [
                        '💡 균형잡기: "이번에는 안 됐지만 다음에는..."',
                        '💡 부분 인정: "완벽하지 않아도 괜찮아"',
                        '💡 성장 관점: "이것도 배움의 기회야"'
                    ]
                },
                'action': {
                    title: '🎯 실행 가능한 구체적 행동',
                    questions: [
                        '지금 당장 할 수 있는 작은 행동은 뭘까요?',
                        '누구에게 도움을 요청할 수 있을까요?',
                        '비슷한 상황에서 다른 사람들은 어떻게 했을까요?',
                        '내일부터 시작할 수 있는 첫 걸음은 뭘까요?'
                    ],
                    example: generateReframeExample(caseTitle, 'action'),
                    tips: [
                        '💡 작은 것부터: 거대한 변화보다 작은 시작',
                        '💡 구체적으로: 언제, 어디서, 어떻게 명확히',
                        '💡 도움 요청: 혼자 해결하려 하지 말고'
                    ]
                }
            };
            
            return guides[reframeType];
        }

        function generateReframeExample(caseTitle, reframeType) {
            // 고민별 맞춤 예시 생성
            const examples = {
                '시험 성적이 나빠서 속상해': {
                    'old': '"이번에도 못했구나. 부모님이 실망하실 거야. 나는 수학을 못하는 아이야." → 너무 극단적이고 자기비판적',
                    'new': '"이번 시험은 잘 안 됐지만, 평소보다 어려운 문제가 많았어. 다음에는 더 체계적으로 준비해볼 수 있어."',
                    'action': '1) 틀린 문제 다시 풀어보기 2) 선생님께 모르는 부분 질문하기 3) 친구와 함께 공부하기 4) 부모님께 솔직하게 이야기하고 도움 요청하기'
                },
                '친구가 내 비밀을 다른 사람에게 말했어': {
                    'old': '"B가 내 비밀을 퍼뜨렸구나. 나를 배신했어. 더 이상 믿을 수 없어." → 관계를 완전히 단절하려는 극단적 생각',
                    'new': '"B가 실수했거나 다른 이유가 있을 수도 있어. 한 번 대화해보고 앞으로 어떻게 할지 정해봐야겠어."',
                    'action': '1) B와 직접 대화해서 상황 확인하기 2) 내 감정을 솔직하게 표현하기 3) 앞으로의 약속 정하기 4) 다른 친구들에게는 사실 확인 후 대응하기'
                },
                '새 학급에 적응하기 어려워': {
                    'old': '"다른 애들은 이미 친해졌는데 나만 혼자야. 뭔가 이상한 걸까? 계속 이럴 것 같아." → 자기 탓만 하고 미래를 부정적으로 예상',
                    'new': '"새로운 환경에 적응하는 건 시간이 걸려. 아직 3주밖에 안 됐으니까 충분히 가능성이 있어."',
                    'action': '1) 관심사가 비슷한 친구 찾아보기 2) 동아리나 모둠 활동 적극 참여하기 3) 먼저 인사하고 말 걸어보기 4) 도움이 필요한 친구 도와주기'
                }
            };
            
            // 현재 고민과 가장 유사한 예시 찾기
            for (const [key, value] of Object.entries(examples)) {
                if (caseTitle.includes(key.split(' ')[0]) || key.includes(caseTitle.split(' ')[0])) {
                    return value[reframeType];
                }
            }
            
            // 기본 예시
            const defaultExamples = {
                'old': '기존 생각을 검토하고 문제점을 찾아보세요.',
                'new': '더 현실적이고 균형잡힌 생각을 만들어보세요.',
                'action': '실제로 실행할 수 있는 구체적인 방법을 생각해보세요.'
            };
            
            return defaultExamples[reframeType];
        }

        function showReframeGuide(reframeType) {
            const guideArea = document.getElementById('reframe-guide-area');
            const guideContent = document.getElementById('reframe-guide-content');
            
            if (!guideArea || !guideContent) return;
            
            const guide = generateReframeGuide(reframeType);
            if (!guide) return;
            
            // 모든 reframe 카드에서 active 클래스 제거
            document.querySelectorAll('.reframe-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // 선택된 카드에 active 클래스 추가
            const selectedCard = document.querySelector(`.reframe-card[data-reframe="${reframeType}"]`);
            if (selectedCard) {
                selectedCard.classList.add('active');
            }
            
            const colorMap = {
                'old': 'gray',
                'new': 'purple',
                'action': 'cyan'
            };
            const color = colorMap[reframeType];
            
            const colorStyles = {
                'old': { bg: '#6b7280', hover: '#4b5563' },
                'new': { bg: '#9333ea', hover: '#7c3aed' },
                'action': { bg: '#06b6d4', hover: '#0891b2' }
            };
            
            guideContent.innerHTML = `
                <div class="space-y-4">
                    <h5 class="font-bold text-gray-800">${guide.title}</h5>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h6 class="font-semibold text-gray-700 mb-2">🤔 이런 질문을 해보세요:</h6>
                            <ul class="space-y-1 text-sm text-gray-600">
                                ${guide.questions.map(q => `<li>• ${q}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div>
                            <h6 class="font-semibold text-gray-700 mb-2">📝 현재 고민의 예시:</h6>
                            <div class="bg-white p-3 rounded-lg text-sm text-gray-700 border-l-4" style="border-left-color: ${colorStyles[reframeType].bg};">
                                ${guide.example}
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h6 class="font-semibold text-gray-700 mb-2">💡 작성 팁:</h6>
                        <div class="flex flex-wrap gap-2">
                            ${guide.tips.map(tip => `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">${tip}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="flex gap-2 pt-2">
                        <button onclick="focusReframeTextarea('${reframeType}')" class="text-white px-4 py-2 rounded-lg text-sm btn-hover" style="background-color: ${colorStyles[reframeType].bg};">
                            ✏️ 작성하러 가기
                        </button>
                        <button onclick="hideReframeGuide()" class="bg-gray-400 text-white px-4 py-2 rounded-lg text-sm btn-hover">
                            ✕ 가이드 닫기
                        </button>
                    </div>
                </div>
            `;
            
            guideArea.classList.remove('hidden');
            guideArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideReframeGuide() {
            const guideArea = document.getElementById('reframe-guide-area');
            if (guideArea) {
                guideArea.classList.add('hidden');
            }
            
            // 모든 카드에서 active 클래스 제거
            document.querySelectorAll('.reframe-card').forEach(card => {
                card.classList.remove('active');
            });
        }

        function focusReframeTextarea(reframeType) {
            let textarea;
            
            if (reframeType === 'new') {
                textarea = document.getElementById('new-thinking');
            } else if (reframeType === 'action') {
                textarea = document.getElementById('help-suggestions');
            } else {
                // 'old'의 경우 ABC 분석 영역으로
                textarea = document.getElementById('abc-analysis');
            }
            
            if (!textarea) return;
            
            // 텍스트영역에 포커스
            textarea.focus();
            
            // 가이드 닫기
            hideReframeGuide();
            
            // 입력 영역 강조 효과
            const colorMap = {
                'old': 'rgba(107, 114, 128, 0.3)',
                'new': 'rgba(147, 51, 234, 0.3)',
                'action': 'rgba(6, 182, 212, 0.3)'
            };
            
            textarea.style.boxShadow = `0 0 0 3px ${colorMap[reframeType]}`;
            setTimeout(() => {
                textarea.style.boxShadow = '';
            }, 2000);
        }

        function showNewThinkingExample() {
            if (!currentCase) {
                alert('먼저 고민 사례를 선택해주세요!');
                return;
            }
            
            const example = generateReframeExample(currentCase.title, 'new');
            
            const useExample = confirm(
                `💜 "${currentCase.title}" 상황의 새로운 생각 예시입니다:\n\n${example}\n\n이 예시를 참고해서 자신만의 새로운 생각을 만들어보세요!\n\n"확인"을 누르면 예시가 입력창에 들어갑니다. (수정 가능)`
            );
            
            if (useExample) {
                const textarea = document.getElementById('new-thinking');
                if (textarea) {
                    textarea.value = example;
                    textarea.focus();
                    saveToLocalStorage();
                }
            }
        }

        function showHelpSuggestionsExample() {
            if (!currentCase) {
                alert('먼저 고민 사례를 선택해주세요!');
                return;
            }
            
            const example = generateReframeExample(currentCase.title, 'action');
            
            const useExample = confirm(
                `🎯 "${currentCase.title}" 상황의 구체적 도움 방법 예시입니다:\n\n${example}\n\n이 예시를 참고해서 실제로 실행할 수 있는 방법을 제안해보세요!\n\n"확인"을 누르면 예시가 입력창에 들어갑니다. (수정 가능)`
            );
            
            if (useExample) {
                const textarea = document.getElementById('help-suggestions');
                if (textarea) {
                    textarea.value = example;
                    textarea.focus();
                    saveToLocalStorage();
                }
            }
        }
        function generateABCGuide(abcType) {
            if (!currentCase) return '';
            
            const caseTitle = currentCase.title;
            
            const guides = {
                'A': {
                    title: '🔍 A: 사실과 사건 분석하기',
                    questions: [
                        '정확히 언제, 어디서 일어났나요?',
                        '누가 관련되어 있었나요?',
                        '실제로 무슨 일이 벌어졌나요?',
                        '다른 사람이 봐도 같은 상황이라고 할 만한 객관적 사실은?'
                    ],
                    example: generateSpecificExample(caseTitle, 'A'),
                    tips: [
                        '💡 내 생각이나 감정은 빼고 오직 사실만',
                        '💡 "~라고 생각한다"는 B에 해당',
                        '💡 카메라로 찍은 것처럼 객관적으로'
                    ]
                },
                'B': {
                    title: '🧠 B: 생각과 신념 찾아보기',
                    questions: [
                        '그 순간 머릿속에 어떤 생각이 떠올랐나요?',
                        '상황을 어떻게 해석했나요?',
                        '어떤 걱정이나 예상을 했나요?',
                        '"~일 것이다", "~해야 한다" 같은 생각이 있었나요?'
                    ],
                    example: generateSpecificExample(caseTitle, 'B'),
                    tips: [
                        '💡 자동으로 떠오른 생각들을 찾아보세요',
                        '💡 "만약에...", "~하면 어떡하지?" 같은 생각',
                        '💡 옳고 그름을 판단한 생각도 포함'
                    ]
                },
                'C': {
                    title: '💫 C: 결과와 반응 파악하기',
                    questions: [
                        '어떤 기분이 들었나요?',
                        '몸은 어떤 반응을 보였나요?',
                        '실제로 어떤 행동을 했나요?',
                        '그 후 상황이 어떻게 되었나요?'
                    ],
                    example: generateSpecificExample(caseTitle, 'C'),
                    tips: [
                        '💡 감정과 행동 둘 다 포함해보세요',
                        '💡 몸의 반응도 중요한 결과예요',
                        '💡 즉시 나타난 것과 나중에 나타난 것 구분'
                    ]
                }
            };
            
            return guides[abcType];
        }

        function generateSpecificExample(caseTitle, abcType) {
            // 고민별 맞춤 예시 생성
            const examples = {
                '시험 성적이 나빠서 속상해': {
                    'A': '수학 시험에서 65점을 받았다. 평균보다 10점 낮은 점수였다.',
                    'B': '"이번에도 못했구나. 부모님이 실망하실 거야. 나는 수학을 못하는 아이야."',
                    'C': '속상하고 부끄러웠다. 집에 가는 길이 무거웠고, 부모님께 말씀드리기 무서웠다.'
                },
                '친구가 내 비밀을 다른 사람에게 말했어': {
                    'A': '내가 A를 좋아한다고 친구 B에게만 말했는데, 며칠 후 다른 반 친구들이 그 이야기를 알고 있었다.',
                    'B': '"B가 내 비밀을 퍼뜨렸구나. 나를 배신했어. 더 이상 믿을 수 없어."',
                    'C': '배신감과 화가 났다. B를 피하게 되었고, 다른 친구들에게도 비밀 이야기를 하지 않게 되었다.'
                },
                '새 학급에 적응하기 어려워': {
                    'A': '새 학기가 시작되고 3주가 지났는데, 아직 함께 점심을 먹거나 이야기할 친구가 생기지 않았다.',
                    'B': '"다른 애들은 이미 친해졌는데 나만 혼자야. 뭔가 이상한 걸까? 계속 이럴 것 같아."',
                    'C': '외롭고 불안했다. 쉬는 시간에 혼자 있게 되고, 학교 가기가 싫어졌다.'
                }
            };
            
            // 현재 고민과 가장 유사한 예시 찾기
            for (const [key, value] of Object.entries(examples)) {
                if (caseTitle.includes(key.split(' ')[0]) || key.includes(caseTitle.split(' ')[0])) {
                    return value[abcType];
                }
            }
            
            // 기본 예시
            const defaultExamples = {
                'A': '구체적인 상황과 사실을 객관적으로 써보세요.',
                'B': '그때 든 생각과 마음속 이야기를 써보세요.',
                'C': '느낀 감정과 한 행동을 써보세요.'
            };
            
            return defaultExamples[abcType];
        }

        function showABCGuide(abcType) {
            const guideArea = document.getElementById('abc-guide-area');
            const guideContent = document.getElementById('abc-guide-content');
            
            if (!guideArea || !guideContent) return;
            
            const guide = generateABCGuide(abcType);
            if (!guide) return;
            
            // 모든 ABC 카드에서 active 클래스 제거
            document.querySelectorAll('.abc-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // 선택된 카드에 active 클래스 추가
            const selectedCard = document.querySelector(`.abc-card[data-abc="${abcType}"]`);
            if (selectedCard) {
                selectedCard.classList.add('active');
            }
            
            guideContent.innerHTML = `
                <div class="space-y-4">
                    <h5 class="font-bold text-gray-800">${guide.title}</h5>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h6 class="font-semibold text-gray-700 mb-2">🤔 이런 질문을 해보세요:</h6>
                            <ul class="space-y-1 text-sm text-gray-600">
                                ${guide.questions.map(q => `<li>• ${q}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div>
                            <h6 class="font-semibold text-gray-700 mb-2">📝 현재 고민의 예시:</h6>
                            <div class="bg-white p-3 rounded-lg text-sm text-gray-700 italic border-l-4 border-${abcType === 'A' ? 'red' : abcType === 'B' ? 'orange' : 'blue'}-400">
                                "${guide.example}"
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h6 class="font-semibold text-gray-700 mb-2">💡 작성 팁:</h6>
                        <div class="flex flex-wrap gap-2">
                            ${guide.tips.map(tip => `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">${tip}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="flex gap-2 pt-2">
                        <button onclick="focusABCTextarea('${abcType}')" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm btn-hover">
                            ✏️ ${abcType} 작성하러 가기
                        </button>
                        <button onclick="hideABCGuide()" class="bg-gray-400 text-white px-4 py-2 rounded-lg text-sm btn-hover">
                            ✕ 가이드 닫기
                        </button>
                    </div>
                </div>
            `;
            
            guideArea.classList.remove('hidden');
            guideArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideABCGuide() {
            const guideArea = document.getElementById('abc-guide-area');
            if (guideArea) {
                guideArea.classList.add('hidden');
            }
            
            // 모든 카드에서 active 클래스 제거
            document.querySelectorAll('.abc-card').forEach(card => {
                card.classList.remove('active');
            });
        }

        function focusABCTextarea(abcType) {
            const textarea = document.getElementById('abc-analysis');
            if (!textarea) return;
            
            // 텍스트영역에 포커스
            textarea.focus();
            
            // 해당 ABC 섹션으로 커서 이동 (기본 템플릿이 있을 경우)
            const content = textarea.value;
            let cursorPosition = 0;
            
            if (abcType === 'A') {
                cursorPosition = content.indexOf('A:') !== -1 ? content.indexOf('A:') + 2 : 0;
            } else if (abcType === 'B') {
                cursorPosition = content.indexOf('B:') !== -1 ? content.indexOf('B:') + 2 : content.length;
            } else if (abcType === 'C') {
                cursorPosition = content.indexOf('C:') !== -1 ? content.indexOf('C:') + 2 : content.length;
            }
            
            textarea.setSelectionRange(cursorPosition, cursorPosition);
            
            // 가이드 닫기
            hideABCGuide();
            
            // 입력 영역 강조 효과
            textarea.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.3)';
            setTimeout(() => {
                textarea.style.boxShadow = '';
            }, 2000);
        }

        function showABCExample() {
            if (!currentCase) {
                alert('먼저 고민 사례를 선택해주세요!');
                return;
            }
            
            const exampleA = generateSpecificExample(currentCase.title, 'A');
            const exampleB = generateSpecificExample(currentCase.title, 'B');
            const exampleC = generateSpecificExample(currentCase.title, 'C');
            
            const exampleText = `A: ${exampleA}\n\nB: ${exampleB}\n\nC: ${exampleC}`;
            
            const useExample = confirm(
                `📝 "${currentCase.title}" 상황의 ABC 분석 예시입니다:\n\n${exampleText}\n\n이 예시를 참고해서 자신만의 ABC 분석을 작성해보세요!\n\n"확인"을 누르면 예시가 입력창에 들어갑니다. (수정 가능)`
            );
            
            if (useExample) {
                const textarea = document.getElementById('abc-analysis');
                if (textarea) {
                    textarea.value = exampleText;
                    textarea.focus();
                    saveToLocalStorage();
                }
            }
        }
        function updateStep(step) {
            currentStep = step;
            
            // 방문한 단계 추가
            if (!visitedSteps.includes(step)) {
                visitedSteps.push(step);
            }
            
            // 모든 단계 숨기기
            [elements.step1, elements.step2, elements.step3, elements.step4]
                .forEach(el => el.classList.add('hidden'));
            
            // 현재 단계 표시
            const stepContents = {
                1: { element: elements.step1, desc: '마음을 따뜻하게 공감해주세요' },
                2: { element: elements.step2, desc: '상황을 함께 정리해보세요' },
                3: { element: elements.step3, desc: '건설적인 해결책을 찾아보세요' },
                4: { element: elements.step4, desc: '따뜻한 격려로 마무리해주세요' }
            };
            
            const current = stepContents[step];
            current.element.classList.remove('hidden');
            elements.stepDesc.textContent = current.desc;
            
            // 단계 네비게이션 업데이트
            updateStepNavigation();
            
            // 이전/다음 버튼 업데이트
            updateNavigationButtons();
            
            // 가이드 업데이트
            updateStepGuide(step);
        }

        function updateStepNavigation() {
            document.querySelectorAll('.step-nav-btn').forEach((btn, index) => {
                const stepNum = index + 1;
                btn.classList.remove('step-nav-active', 'step-nav-visited', 'step-nav-completed');
                btn.style.background = '';
                btn.style.color = '';
                btn.style.cursor = '';
                
                if (stepNum === currentStep) {
                    // 현재 단계 - 재생 아이콘과 강조
                    btn.classList.add('step-nav-active');
                    btn.style.background = '#10b981';
                    btn.style.color = 'white';
                    btn.style.cursor = 'pointer';
                    btn.innerHTML = `▶️ ${stepNum}단계<br><span class="text-xs">진행중</span>`;
                } else if (visitedSteps.includes(stepNum)) {
                    // 완료된 단계 - 체크 아이콘
                    btn.classList.add('step-nav-completed');
                    btn.style.background = '#d1fae5';
                    btn.style.color = '#065f46';
                    btn.style.cursor = 'pointer';
                    btn.innerHTML = `✅ ${stepNum}단계<br><span class="text-xs">완료</span>`;
                } else if (stepNum === currentStep + 1) {
                    // 다음 단계 - 접근 가능
                    btn.style.background = '#bfdbfe';
                    btn.style.color = '#1e40af';
                    btn.style.cursor = 'pointer';
                    const stepNames = ['공감하기', 'ABC 분석', '새로운 생각', '격려하기'];
                    btn.innerHTML = `⏭️ ${stepNum}단계<br><span class="text-xs">${stepNames[stepNum-1]}</span>`;
                } else {
                    // 접근 불가 단계
                    btn.style.background = '#e5e7eb';
                    btn.style.color = '#9ca3af';
                    btn.style.cursor = 'not-allowed';
                    const stepIcons = ['💚', '🔍', '✨', '🎁'];
                    const stepNames = ['공감하기', 'ABC 분석', '새로운 생각', '격려하기'];
                    btn.innerHTML = `${stepIcons[stepNum-1]} ${stepNum}단계<br><span class="text-xs">${stepNames[stepNum-1]}</span>`;
                }
            });
        }

        function updateNavigationButtons() {
            // 이전 단계 버튼
            if (currentStep === 1) {
                elements.prevStepBtn.disabled = true;
                elements.prevStepBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                elements.prevStepBtn.disabled = false;
                elements.prevStepBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // 4단계에서는 사이드바의 다음 단계 버튼 숨기기 (4단계 내부에 저장 버튼이 있음)
            if (currentStep === 4) {
                elements.nextStepBtn.style.display = 'none';
            } else {
                elements.nextStepBtn.style.display = 'block';
                elements.nextStepBtn.textContent = '➡️ 다음 단계로';
                elements.nextStepBtn.className = 'w-full bg-blue-500 text-white font-bold py-2 rounded-lg btn-hover';
            }
        }

        function updateStepGuide(step) {
            const guides = {
                1: `
                    <div class="bg-green-50 p-3 rounded-lg">
                        <div class="font-bold text-green-700">💚 공감 포인트</div>
                        <ul class="list-disc ml-4 text-green-600 text-sm">
                            <li>감정을 인정해주기</li>
                            <li>"힘들었겠구나" 표현</li>
                            <li>비슷한 경험 공유</li>
                        </ul>
                    </div>`,
                2: `
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="font-bold text-blue-700">🔍 ABC 분석 방법</div>
                        <ul class="list-disc ml-4 text-blue-600 text-sm">
                            <li>A: 정확한 사실만</li>
                            <li>B: 그때 든 생각</li>
                            <li>C: 감정과 행동</li>
                        </ul>
                    </div>`,
                3: `
                    <div class="bg-purple-50 p-3 rounded-lg">
                        <div class="font-bold text-purple-700">✨ 생각 바꾸기</div>
                        <ul class="list-disc ml-4 text-purple-600 text-sm">
                            <li>현실적인 관점 제시</li>
                            <li>구체적인 해결책</li>
                            <li>작은 행동부터</li>
                        </ul>
                    </div>`,
                4: `
                    <div class="bg-pink-50 p-3 rounded-lg">
                        <div class="font-bold text-pink-700">🎁 격려하기</div>
                        <ul class="list-disc ml-4 text-pink-600 text-sm">
                            <li>진심 어린 응원</li>
                            <li>친구의 강점 언급</li>
                            <li>함께 있다는 메시지</li>
                        </ul>
                    </div>`
            };
            
            elements.stepGuide.innerHTML = guides[step];
        }

        // ===== 역할 관리 =====
        function updateRoleDisplay() {
            const consultantName = document.getElementById('consultant-name')?.value || '컨설턴트';
            const clientName = document.getElementById('client-name')?.value || '내담자';
            
            const roleDisplay = elements.roleDisplay || document.getElementById('role-display');
            if (!roleDisplay) {
                console.error('role-display 요소를 찾을 수 없습니다');
                return;
            }
            
            if (isConsultant) {
                roleDisplay.className = 'role-consultant p-3 rounded-lg text-center';
                roleDisplay.innerHTML = `
                    <div class="font-bold">👨‍🏫 현재 컨설턴트</div>
                    <div class="text-sm">${consultantName}</div>
                `;
            } else {
                roleDisplay.className = 'role-client p-3 rounded-lg text-center';
                roleDisplay.innerHTML = `
                    <div class="font-bold">🙋‍♀️ 현재 내담자</div>
                    <div class="text-sm">${clientName}</div>
                `;
            }
        }

        function switchRoles() {
            // 이름과 학급 정보 자동 교체
            const consultantNameInput = document.getElementById('consultant-name');
            const clientNameInput = document.getElementById('client-name');
            const consultantClassInput = document.getElementById('consultant-class');
            const clientClassInput = document.getElementById('client-class');
            
            // 값 교체 (ES6 구조분해할당 사용)
            [consultantNameInput.value, clientNameInput.value] = [clientNameInput.value, consultantNameInput.value];
            [consultantClassInput.value, clientClassInput.value] = [clientClassInput.value, consultantClassInput.value];
            
            // 역할 상태 변경
            isConsultant = !isConsultant;
            updateRoleDisplay();
            
            // 사용자에게 안내
            alert('✅ 역할이 교체되었습니다!\n\n👨‍🏫 새로운 컨설턴트: ' + consultantNameInput.value + 
                  '\n🙋‍♀️ 새로운 내담자: ' + clientNameInput.value + 
                  '\n\n새로운 사례로 역할극을 시작해보세요.');
            
            // 새로운 사례로 리셋하거나 계속 진행할지 선택
            if (confirm('새로운 사례로 다시 시작하시겠어요?\n\n• 확인: 새 사례로 처음부터\n• 취소: 현재 단계에서 계속')) {
                resetRoleplay();
                showScreen('start');
            }
        }

        // ===== 컨설팅 데이터 수집 =====
        function collectConsultationData() {
            // 뽑힌 격려 메시지 수집
            const drawnMessage = document.getElementById('encouragement-message').textContent;
            const isDefaultMessage = drawnMessage === '격려 메시지를 뽑아보세요!';
            
            consultationData = {
                case: currentCase,
                consultant: {
                    name: document.getElementById('consultant-name').value || '컨설턴트',
                    class: document.getElementById('consultant-class').value || '-'
                },
                client: {
                    name: document.getElementById('client-name').value || '내담자',
                    class: document.getElementById('client-class').value || '-'
                },
                selectedEmotions: selectedEmotions.slice(), // 배열 복사
                empathy: document.getElementById('empathy-text').value || '(작성되지 않음)',
                abcAnalysis: document.getElementById('abc-analysis').value || '(작성되지 않음)',
                newThinking: document.getElementById('new-thinking').value || '(작성되지 않음)',
                helpSuggestions: document.getElementById('help-suggestions').value || '(작성되지 않음)',
                drawnEncouragement: isDefaultMessage ? '' : drawnMessage,
                personalEncouragement: document.getElementById('personal-encouragement').value || '(작성되지 않음)',
                timestamp: new Date().toLocaleString('ko-KR')
            };
        }

        function generateSummary() {
            // 참가자 정보 표시
            document.getElementById('consultation-info').innerHTML = `
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 text-sm">
                    <div class="role-consultant px-4 py-2 rounded-full">
                        <span class="font-semibold">👨‍🏫 컨설턴트:</span> ${consultationData.consultant.name} (${consultationData.consultant.class})
                    </div>
                    <div class="role-client px-4 py-2 rounded-full">
                        <span class="font-semibold">🙋‍♀️ 내담자:</span> ${consultationData.client.name} (${consultationData.client.class})
                    </div>
                </div>
            `;
            
            // 완료 시간 표시
            document.getElementById('completion-time').textContent = consultationData.timestamp;
            
            // 주요 내용 요약
            const summary = `
                <div class="space-y-8">
                    <!-- 다룬 고민 -->
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-6 rounded-xl border-l-4 border-blue-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                            💭 다룬 고민
                        </h3>
                        <div class="space-y-2">
                            <div class="font-semibold text-lg text-blue-700">${consultationData.case.title}</div>
                            <div class="text-gray-700 leading-relaxed bg-white p-4 rounded-lg">
                                "${consultationData.case.content}"
                            </div>
                        </div>
                    </div>
                    
                    <!-- 4단계 컨설팅 결과 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 1단계: 공감하기 -->
                        <div class="bg-green-50 p-5 rounded-xl border-l-4 border-green-500">
                            <h3 class="text-lg font-bold text-green-700 mb-3 flex items-center">
                                💚 1단계: 마음 공감하기
                            </h3>
                            <div class="space-y-3">
                                ${consultationData.selectedEmotions.length > 0 ? `
                                    <div>
                                        <div class="text-sm font-semibold text-green-600 mb-1">파악한 감정:</div>
                                        <div class="flex flex-wrap gap-1">
                                            ${consultationData.selectedEmotions.map(emotion => 
                                                `<span class="bg-green-100 px-2 py-1 rounded-full text-xs">${emotion}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                <div>
                                    <div class="text-sm font-semibold text-green-600 mb-1">공감 표현:</div>
                                    <div class="bg-white p-3 rounded-lg text-sm leading-relaxed">
                                        "${consultationData.empathy}"
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 2단계: ABC 분석 -->
                        <div class="bg-blue-50 p-5 rounded-xl border-l-4 border-blue-500">
                            <h3 class="text-lg font-bold text-blue-700 mb-3 flex items-center">
                                🔍 2단계: ABC 분석하기
                            </h3>
                            <div class="bg-white p-3 rounded-lg text-sm leading-relaxed">
                                "${consultationData.abcAnalysis}"
                            </div>
                        </div>
                        
                        <!-- 3단계: 새로운 생각 -->
                        <div class="bg-purple-50 p-5 rounded-xl border-l-4 border-purple-500">
                            <h3 class="text-lg font-bold text-purple-700 mb-3 flex items-center">
                                ✨ 3단계: 새로운 생각 만들기
                            </h3>
                            <div class="space-y-3">
                                <div>
                                    <div class="text-sm font-semibold text-purple-600 mb-1">건강한 생각:</div>
                                    <div class="bg-white p-3 rounded-lg text-sm leading-relaxed">
                                        "${consultationData.newThinking}"
                                    </div>
                                </div>
                                <div>
                                    <div class="text-sm font-semibold text-purple-600 mb-1">구체적 도움:</div>
                                    <div class="bg-white p-3 rounded-lg text-sm leading-relaxed">
                                        "${consultationData.helpSuggestions}"
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 4단계: 격려하기 -->
                        <div class="bg-pink-50 p-5 rounded-xl border-l-4 border-pink-500">
                            <h3 class="text-lg font-bold text-pink-700 mb-3 flex items-center">
                                🎁 4단계: 따뜻한 격려하기
                            </h3>
                            <div class="space-y-3">
                                ${consultationData.drawnEncouragement ? `
                                    <div>
                                        <div class="text-sm font-semibold text-pink-600 mb-1">뽑힌 격려 메시지:</div>
                                        <div class="bg-gradient-to-r from-pink-100 to-purple-100 p-3 rounded-lg text-sm leading-relaxed font-medium">
                                            "${consultationData.drawnEncouragement}"
                                        </div>
                                    </div>
                                ` : ''}
                                <div>
                                    <div class="text-sm font-semibold text-pink-600 mb-1">나만의 격려 메시지:</div>
                                    <div class="bg-white p-3 rounded-lg text-sm leading-relaxed">
                                        "${consultationData.personalEncouragement}"
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 컨설팅 하이라이트 -->
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-xl border border-yellow-200">
                        <h3 class="text-lg font-bold text-yellow-800 mb-3 text-center">
                            ⭐ 이번 컨설팅의 하이라이트
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div class="bg-white p-3 rounded-lg">
                                <div class="text-2xl mb-1">💝</div>
                                <div class="text-sm font-semibold text-gray-700">공감과 이해</div>
                                <div class="text-xs text-gray-500">따뜻한 마음으로 들어주기</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg">
                                <div class="text-2xl mb-1">🔍</div>
                                <div class="text-sm font-semibold text-gray-700">체계적 분석</div>
                                <div class="text-xs text-gray-500">ABC 모델로 문제 파악</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg">
                                <div class="text-2xl mb-1">🌱</div>
                                <div class="text-sm font-semibold text-gray-700">긍정적 변화</div>
                                <div class="text-xs text-gray-500">새로운 관점과 격려</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            elements.consultationSummary.innerHTML = summary;
        }

        // ===== 메인 플로우 =====
        function startRoleplay() {
            console.log('startRoleplay 호출됨');
            console.log('currentCase:', currentCase);
            
            const consultantName = document.getElementById('consultant-name').value.trim();
            const clientName = document.getElementById('client-name').value.trim();
            
            console.log('참가자 정보:', consultantName, clientName);
            
            if (!consultantName || !clientName) {
                alert('컨설턴트와 내담자 이름을 모두 입력해주세요!');
                return;
            }
            
            if (!currentCase) {
                alert('먼저 고민 사례를 선택해주세요!\n\n• 준비된 사례: 카드를 클릭해서 선택\n• 직접 입력: 제목과 내용을 모두 작성');
                return;
            }
            
            console.log('역할극 시작 조건 만족, 화면 전환 시작');
            
            // 상태 초기화
            currentStep = 1;
            visitedSteps = [1];
            selectedEmotions = [];
            
            // 사례 표시
            elements.displayedTitle.textContent = currentCase.title;
            elements.displayedContent.textContent = currentCase.content;
            
            // 역할 표시 업데이트
            updateRoleDisplay();
            
            // 추천 감정들 표시
            updateRecommendedEmotions();
            updateSelectedEmotionsDisplay();
            
            // 첫 번째 단계로 시작
            updateStep(1);
            
            console.log('화면 전환 실행');
            showScreen('roleplay');
        }

        function resetRoleplay() {
            currentStep = 1;
            visitedSteps = [1]; // 방문한 단계 초기화
            selectedEmotions = []; // 선택된 감정 초기화
            updateStep(1);
            
            // 모든 입력 필드 초기화
            document.querySelectorAll('textarea').forEach(textarea => {
                if (textarea.id !== 'custom-title' && textarea.id !== 'custom-content') {
                    textarea.value = '';
                }
            });
            
            // 직접 입력 필드 초기화
            const directEmotionInput = document.getElementById('direct-emotion-input');
            if (directEmotionInput) {
                directEmotionInput.value = '';
            }
            
            // 감정 버튼 초기화
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 선택된 감정 표시 초기화
            updateSelectedEmotionsDisplay();
            
            // 격려 메시지 초기화
            document.getElementById('encouragement-message').textContent = '격려 메시지를 뽑아보세요!';
        }

        function finishRoleplay() {
            collectConsultationData();
            generateSummary();
            showScreen('result');
        }

        // ===== 이미지 다운로드 & 인쇄 기능 =====
        async function loadHtml2Canvas() {
            // html2canvas가 이미 로드되어 있는지 확인
            if (typeof html2canvas !== 'undefined') {
                return true;
            }
            
            try {
                // 동적으로 html2canvas 로드
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    script.onload = () => {
                        if (typeof html2canvas !== 'undefined') {
                            resolve(true);
                        } else {
                            reject(new Error('html2canvas 로드 실패'));
                        }
                    };
                    script.onerror = () => reject(new Error('스크립트 로드 실패'));
                    document.head.appendChild(script);
                });
            } catch (error) {
                console.error('html2canvas 로드 오류:', error);
                return false;
            }
        }

        async function downloadAsImage() {
            const button = elements.downloadImageBtn;
            const originalText = button.textContent;
            
            try {
                button.textContent = '📷 라이브러리 로딩 중...';
                button.disabled = true;
                
                // html2canvas 로드 확인 및 로딩
                const isLoaded = await loadHtml2Canvas();
                if (!isLoaded) {
                    throw new Error('이미지 생성 라이브러리를 로드할 수 없습니다.');
                }
                
                button.textContent = '📷 이미지 생성 중...';
                
                const element = document.getElementById('printable-consultation');
                if (!element) {
                    throw new Error('캡처할 요소를 찾을 수 없습니다.');
                }
                
                // 스크롤을 맨 위로 이동
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // 잠시 기다려서 렌더링 완료 보장
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                console.log('html2canvas 시작...');
                
                const canvas = await html2canvas(element, {
                    scale: 1.5, // 적절한 해상도
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: 1200, // 고정 너비
                    windowHeight: 800,  // 고정 높이
                    onclone: (clonedDoc) => {
                        // 클론된 문서에서 no-print 클래스 제거
                        const noPrintElements = clonedDoc.querySelectorAll('.no-print');
                        noPrintElements.forEach(el => el.style.display = 'none');
                    }
                });
                
                console.log('캔버스 생성 완료:', canvas.width, 'x', canvas.height);
                
                // 캔버스가 제대로 생성되었는지 확인
                if (canvas.width === 0 || canvas.height === 0) {
                    throw new Error('이미지가 제대로 생성되지 않았습니다.');
                }
                
                // 이미지 다운로드
                const link = document.createElement('a');
                const timestamp = new Date();
                const dateStr = `${timestamp.getFullYear()}${(timestamp.getMonth()+1).toString().padStart(2,'0')}${timestamp.getDate().toString().padStart(2,'0')}_${timestamp.getHours().toString().padStart(2,'0')}${timestamp.getMinutes().toString().padStart(2,'0')}`;
                
                link.download = `ABC컨설팅_${consultationData.consultant.name}_${consultationData.client.name}_${dateStr}.png`;
                
                // 이미지 품질 최적화
                const dataURL = canvas.toDataURL('image/png', 1.0);
                link.href = dataURL;
                
                // 다운로드 실행
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 성공 메시지
                button.textContent = '✅ 저장 완료!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
                
            } catch (error) {
                console.error('이미지 생성 오류:', error);
                
                // 구체적인 오류 메시지 제공
                let errorMessage = '이미지 저장에 실패했습니다.\n\n';
                
                if (error.message.includes('라이브러리')) {
                    errorMessage += '• 인터넷 연결을 확인해주세요\n• 브라우저를 새로고침해주세요';
                } else if (error.message.includes('캔버스') || error.message.includes('이미지')) {
                    errorMessage += '• 다른 브라우저를 사용해보세요\n• 팝업 차단을 해제해주세요';
                } else {
                    errorMessage += '• 인쇄 기능(PDF 저장)을 이용해주세요\n• 스크린샷을 활용해주세요';
                }
                
                alert(errorMessage);
                
                // 대안 제시
                if (confirm('인쇄 기능을 사용하시겠습니까?\n(브라우저에서 "PDF로 저장" 선택 가능)')) {
                    printConsultation();
                } else if (confirm('전체화면으로 보고 스크린샷을 찍으시겠습니까?')) {
                    showFullscreen();
                }
                
            } finally {
                button.disabled = false;
                if (button.textContent.includes('생성 중') || button.textContent.includes('로딩 중')) {
                    button.textContent = originalText;
                }
            }
        }

        function printConsultation() {
            try {
                // 인쇄 전 스크롤 위치 조정
                document.getElementById('printable-consultation').scrollIntoView();
                setTimeout(() => {
                    window.print();
                }, 500);
            } catch (error) {
                console.error('인쇄 오류:', error);
                alert('인쇄 기능을 사용할 수 없습니다.\n브라우저 설정에서 팝업을 허용해주세요.');
            }
        }

        function showFullscreen() {
            const element = document.getElementById('printable-consultation');
            
            // 모달 생성
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-5xl max-h-[90vh] overflow-auto relative">
                    <button id="close-fullscreen" class="absolute top-4 right-4 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-600 z-10">
                        ✕
                    </button>
                    <div id="fullscreen-content" class="p-6">
                        ${element.innerHTML}
                    </div>
                    <div class="p-4 bg-gray-50 text-center text-sm text-gray-600">
                        <p>💡 <strong>스크린샷 방법:</strong></p>
                        <p><strong>Windows:</strong> Win + Shift + S 또는 Print Screen</p>
                        <p><strong>Mac:</strong> Cmd + Shift + 4</p>
                        <p><strong>모바일:</strong> 전원 + 볼륨다운 (기종별 상이)</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 닫기 버튼 이벤트
            document.getElementById('close-fullscreen').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 배경 클릭으로 닫기
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // ESC 키로 닫기
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // ===== 이벤트 리스너 =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM 로드 완료');
            
            // removeEmotion과 ABC, Reframe 관련 함수들을 전역으로 등록
            window.removeEmotion = removeEmotion;
            window.focusABCTextarea = focusABCTextarea;
            window.hideABCGuide = hideABCGuide;
            window.focusReframeTextarea = focusReframeTextarea;
            window.hideReframeGuide = hideReframeGuide;
            
            // 저장된 데이터 복구 시도
            const dataRestored = loadFromLocalStorage();
            
            if (dataRestored) {
                // 데이터가 복구된 경우
                if (currentCase && currentStep > 1) {
                    // 역할극 화면으로 이동
                    elements.displayedTitle.textContent = currentCase.title;
                    elements.displayedContent.textContent = currentCase.content;
                    updateRoleDisplay();
                    updateRecommendedEmotions();
                    updateSelectedEmotionsDisplay();
                    updateStep(currentStep);
                    showScreen('roleplay');
                } else if (currentCase) {
                    // 시작 화면에서 사례가 선택된 상태로 복구
                    if (displayedCasesIndices.length > 0) {
                        renderCaseCards();
                        updateSelectedCaseDisplay();
                    } else {
                        generateRandomCases(6);
                    }
                } else {
                    // 일반적인 초기화
                    generateRandomCases(6);
                }
            } else {
                // 새로 시작하는 경우
                generateRandomCases(6);
            }
            
            // 총 사례 수 표시
            const totalCasesElement = document.getElementById('total-cases-count');
            if (totalCasesElement) {
                totalCasesElement.textContent = sampleCases.length;
            }

            // 수동 저장 버튼
            const manualSaveBtn = document.getElementById('manual-save-btn');
            if (manualSaveBtn) {
                manualSaveBtn.addEventListener('click', () => {
                    saveToLocalStorage();
                    showSaveStatus('💾 수동 저장 완료!');
                });
            }

            // 데이터 초기화 버튼
            const clearDataBtn = document.getElementById('clear-data-btn');
            if (clearDataBtn) {
                clearDataBtn.addEventListener('click', () => {
                    if (confirm('⚠️ 정말 모든 데이터를 삭제하시겠어요?\n\n삭제하면 복구할 수 없습니다.')) {
                        clearSavedData();
                        location.reload();
                    }
                });
            }

            // 페이지 떠나기 전 경고 설정
            setupBeforeUnloadWarning();
            
            // 자동 저장 시작 (입력 필드에 대한 이벤트 리스너와 함께)
            document.querySelectorAll('input, textarea').forEach(element => {
                element.addEventListener('input', () => {
                    // 입력이 있을 때마다 1초 후 저장 (디바운싱)
                    clearTimeout(element._saveTimeout);
                    element._saveTimeout = setTimeout(saveToLocalStorage, 1000);
                });
            });
            
            // 모드 선택
            elements.randomMode.addEventListener('click', () => {
                console.log('랜덤 모드 선택');
                elements.randomMode.classList.add('active', 'text-white');
                elements.randomMode.classList.remove('bg-gray-300', 'text-gray-700');
                elements.customMode.classList.remove('active', 'text-white');
                elements.customMode.classList.add('bg-gray-300', 'text-gray-700');
                
                elements.randomCaseArea.classList.remove('hidden');
                elements.customCaseArea.classList.add('hidden');
                
                // 랜덤 모드로 전환시 새로운 카드들 생성
                generateRandomCases(6);
                saveToLocalStorage();
            });
            
            elements.customMode.addEventListener('click', () => {
                console.log('커스텀 모드 선택');
                elements.customMode.classList.add('active', 'text-white');
                elements.customMode.classList.remove('bg-gray-300', 'text-gray-700');
                elements.randomMode.classList.remove('active', 'text-white');
                elements.randomMode.classList.add('bg-gray-300', 'text-gray-700');
                
                elements.customCaseArea.classList.remove('hidden');
                elements.randomCaseArea.classList.add('hidden');
                
                // 커스텀 모드로 전환시 선택 상태 초기화
                selectedCaseIndex = null;
                currentCase = null;
                useCustomCase();
                saveToLocalStorage();
            });
            
            // 사례 섞기
            elements.shuffleCasesBtn.addEventListener('click', () => {
                console.log('다른 예시 보기 클릭');
                shuffleCases();
                saveToLocalStorage();
            });
            
            // 커스텀 사례 사용
            elements.customTitle.addEventListener('input', () => {
                useCustomCase();
                saveToLocalStorage();
            });
            elements.customContent.addEventListener('input', () => {
                useCustomCase();
                saveToLocalStorage();
            });
            
            // 직접 감정 입력
            const addDirectEmotionBtn = document.getElementById('add-direct-emotion-btn');
            if (addDirectEmotionBtn) {
                addDirectEmotionBtn.addEventListener('click', addDirectEmotion);
            }
            
            const directEmotionInput = document.getElementById('direct-emotion-input');
            if (directEmotionInput) {
                directEmotionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addDirectEmotion();
                    }
                });
            }
            
            // 역할극 시작
            elements.startRoleplayBtn.addEventListener('click', () => {
                startRoleplay();
                startAutoSave(); // 역할극 시작 시 자동저장 활성화
            });
            
            // 단계 진행
            elements.nextStepBtn.addEventListener('click', () => {
                if (currentStep < 4) {
                    updateStep(currentStep + 1);
                } else {
                    finishRoleplay();
                }
                saveToLocalStorage();
            });
            
            // 이전 단계로
            elements.prevStepBtn.addEventListener('click', () => {
                if (currentStep > 1) {
                    updateStep(currentStep - 1);
                }
                saveToLocalStorage();
            });
            
            // 단계 네비게이션 클릭
            document.querySelectorAll('.step-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetStep = parseInt(btn.dataset.step);
                    // 방문한 단계 또는 다음 단계만 클릭 가능
                    if (visitedSteps.includes(targetStep) || targetStep === currentStep + 1) {
                        updateStep(targetStep);
                        saveToLocalStorage();
                    }
                });
            });
            
            // 역할 바꾸기
            elements.switchRolesBtn.addEventListener('click', () => {
                switchRoles();
                saveToLocalStorage();
            });
            
            // ABC 카드 클릭
            document.querySelectorAll('.abc-card').forEach(card => {
                card.addEventListener('click', () => {
                    const abcType = card.dataset.abc;
                    showABCGuide(abcType);
                    card.classList.toggle('filled');
                });
            });
            
            // ABC 예시 보기 버튼
            const abcExampleBtn = document.getElementById('abc-example-btn');
            if (abcExampleBtn) {
                abcExampleBtn.addEventListener('click', showABCExample);
            }
            
            // 3단계 Reframe 카드 클릭
            document.querySelectorAll('.reframe-card').forEach(card => {
                card.addEventListener('click', () => {
                    const reframeType = card.dataset.reframe;
                    showReframeGuide(reframeType);
                });
            });
            
            // 3단계 예시 보기 버튼들
            const newThinkingExampleBtn = document.getElementById('new-thinking-example-btn');
            if (newThinkingExampleBtn) {
                newThinkingExampleBtn.addEventListener('click', showNewThinkingExample);
            }
            
            const helpSuggestionsExampleBtn = document.getElementById('help-suggestions-example-btn');
            if (helpSuggestionsExampleBtn) {
                helpSuggestionsExampleBtn.addEventListener('click', showHelpSuggestionsExample);
            }
            
            // 격려 메시지 뽑기
            const drawEncouragementBtn = document.getElementById('draw-encouragement-btn');
            if (drawEncouragementBtn) {
                drawEncouragementBtn.addEventListener('click', () => {
                    const randomMessage = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
                    document.getElementById('encouragement-message').textContent = randomMessage;
                });
            }
            
            // 컨설팅 저장 (4단계에서)
            elements.saveConsultationBtn.addEventListener('click', () => {
                finishRoleplay();
                stopAutoSave(); // 완료 시 자동저장 중단
                clearSavedData(); // 저장된 임시 데이터 삭제
            });
            
            // 이미지 다운로드
            elements.downloadImageBtn.addEventListener('click', downloadAsImage);
            
            // 인쇄하기
            elements.printConsultationBtn.addEventListener('click', printConsultation);
            
            // 전체화면 보기
            elements.fullscreenBtn.addEventListener('click', showFullscreen);
            
            // 결과 화면 버튼들
            elements.switchAndRestartBtn.addEventListener('click', () => {
                switchRoles();
                resetRoleplay();
                clearSavedData(); // 새로 시작할 때 임시 데이터 삭제
                showScreen('start');
            });
            
            elements.newCaseBtn.addEventListener('click', () => {
                resetRoleplay();
                clearSavedData(); // 새로 시작할 때 임시 데이터 삭제
                showScreen('start');
            });
            
            elements.restartBtn.addEventListener('click', () => {
                clearSavedData(); // 처음으로 돌아갈 때 임시 데이터 삭제
                location.reload();
            });
        });
    </script>
</body>
</html>
